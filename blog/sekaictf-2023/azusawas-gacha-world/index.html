<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="theme-color" content="#171717">
    <script src="https://kit.fontawesome.com/129342a70b.js" crossorigin="anonymous"></script>
    

    <meta name="description" content="I created a fully functional, hackable replica of Project Sekai&#39;s gacha system for SekaiCTF 2023. This was my design process.">
<meta property="og:type" content="article">
<meta property="og:title" content="SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System">
<meta property="og:url" content="https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/index.html">
<meta property="og:site_name" content="enscribe.dev">
<meta property="og:description" content="I created a fully functional, hackable replica of Project Sekai&#39;s gacha system for SekaiCTF 2023. This was my design process.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://enscribe.dev/static/sekaictf-2023/banner.webp">
<meta property="article:published_time" content="2023-08-27T16:00:00.000Z">
<meta property="article:modified_time" content="2023-08-30T18:25:56.296Z">
<meta property="article:author" content="enscribe">
<meta property="article:tag" content="unity">
<meta property="article:tag" content="game-hacking">
<meta property="article:tag" content="reverse-engineering">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://enscribe.dev/static/sekaictf-2023/banner.webp">
    
    
      
        
          <link rel="shortcut icon" href="/static/favicon.png">
        
      
      
        
          <link rel="icon" type="image/png" href="/static/favicon.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon.png">
        
      
    
    <!-- title -->
    <title>SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">home</a></li><!--
     --><!--
       --><li><a href="/articles/">posts</a></li><!--
     --><!--
       --><li><a href="/ctfs/">ctfs</a></li><!--
     --><!--
       --><li><a href="/profiles/">profiles</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="next post" href="/blog/actf-2023/gcd-query/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">previous post</span>
      <span id="i-next" class="info" style="display:none;">next post</span>
      <span id="i-top" class="info" style="display:none;">back to top</span>
      <span id="i-share" class="info" style="display:none;">share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/&text=SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/&title=SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/&is_video=false&description=SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System&body=Check out this article: https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/&title=SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/&name=SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Intro"><span class="toc-number">1.</span> <span class="toc-text">Intro</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-%E2%80%9CGacha-Game%E2%80%9D-Model"><span class="toc-number"></span> <span class="toc-text">The “Gacha Game” Model</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%80%9CPity%E2%80%9D-Mechanics"><span class="toc-number">1.</span> <span class="toc-text">“Pity” Mechanics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Considering-Challenge-Difficulty"><span class="toc-number">2.</span> <span class="toc-text">Considering Challenge Difficulty</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Designing-the-Challenge-Brainstorming"><span class="toc-number"></span> <span class="toc-text">Designing the Challenge: Brainstorming</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementing-the-Challenge-Backend"><span class="toc-number"></span> <span class="toc-text">Implementing the Challenge: Backend</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Replicating-UI-Elements-with-Figma"><span class="toc-number"></span> <span class="toc-text">Replicating UI Elements with Figma</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementing-the-Challenge-Unity"><span class="toc-number"></span> <span class="toc-text">Implementing the Challenge: Unity</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GachaManager-cs"><span class="toc-number">1.</span> <span class="toc-text">GachaManager.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GameState-cs"><span class="toc-number">2.</span> <span class="toc-text">GameState.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UIManager-cs"><span class="toc-number">3.</span> <span class="toc-text">UIManager.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AudioController-cs"><span class="toc-number">4.</span> <span class="toc-text">AudioController.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BackgroundScroller-cs"><span class="toc-number">5.</span> <span class="toc-text">BackgroundScroller.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ShrinkButton-cs"><span class="toc-number">6.</span> <span class="toc-text">ShrinkButton.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CameraScaler-cs"><span class="toc-number">7.</span> <span class="toc-text">CameraScaler.cs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Writeup"><span class="toc-number"></span> <span class="toc-text">Writeup</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Azusawa's-Gacha-World"><span class="toc-number">1.</span> <span class="toc-text">Azusawa&#39;s Gacha World</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Afterword"><span class="toc-number">2.</span> <span class="toc-text">Afterword</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">enscribe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-08-27T16:00:00.000Z" itemprop="datePublished">Aug 27, 2023</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/blog/">blog</a> › <a class="category-link" href="/categories/blog/sekaictf-2023/">sekaictf-2023</a> › <a class="category-link" href="/categories/blog/sekaictf-2023/reverse/">reverse</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/game-hacking/" rel="tag">game-hacking</a>, <a class="tag-link-link" href="/tags/reverse-engineering/" rel="tag">reverse-engineering</a>, <a class="tag-link-link" href="/tags/unity/" rel="tag">unity</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><img src="/static/sekaictf-2023/banner.png" alt="Banner"></p>
<h3 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h3><p>This blog post details my design process for a beginner-friendly reverse-engineering challenge that I authored this year for <a target="_blank" rel="noopener" href="https://ctftime.org/event/1923/">SekaiCTF 2023</a>——a fully functional, hackable replica of Project Sekai’s “gacha” system. Here is a snippet of the challenge, featured in the CTF’s first teaser:</p>
<div class="twitter-wrapper"><blockquote class="twitter-tweet tw-align-center" data-theme="dark" style="width: 400"><a target="_blank" rel="noopener" href="https://twitter.com/ProjectSEKAIctf/status/1688745825504268288"></a></blockquote></div><script async="" defer="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>Dubbed “Azusawa’s Gacha World”, this challenge took heavy theming inspiration from a team friend with the handle <a target="_blank" rel="noopener" href="https://github.com/stypr">@stypr</a>, who singlehandedly spent over USD$30,000 on <a target="_blank" rel="noopener" href="https://projectsekai.fandom.com/wiki/Project_SEKAI_COLORFUL_STAGE!">Project Sekai</a> (the mobile rhythm game). He also runs a website called <a target="_blank" rel="noopener" href="https://azusawa.world/">azusawa.world</a>, which features his experiences with a character named <a target="_blank" rel="noopener" href="https://projectsekai.fandom.com/wiki/Azusawa_Kohane">Kohane Azsuawa</a> (小豆沢こはね)——this challenge is part of a recurring meme about this particular character.</p>
<h2 id="The-“Gacha-Game”-Model"><a href="#The-“Gacha-Game”-Model" class="headerlink" title="The “Gacha Game” Model"></a>The “Gacha Game” Model</h2><p>In the context of video games, a <strong>gacha game</strong> is a model which implements a “random vending machine” mechanic as a method of obtaining rare characters, cards, or other collectible items (collectively referred to as “<strong>drops</strong>“ for the rest of this blog post, for brevity). The name originates from the Japanese word <em>gashapon</em> (ガチャポン), an onomatopoeia for the act of cranking the vending machine’s handle (and Bandai’s trademark name). The term is also used as a verb to describe the act of “rolling” or “pulling” for a desired drop (e.g. “I’m going to gacha for this character”).</p>
<p>The gacha mechanic is most commonly found in free-to-play mobile games, and is often implemented as a monetization strategy. Players are incentivized to exchange their in-game currency to “pull”, “spin”, “roll”, etc. on specific “banners” which feature a particular <strong>pool</strong> of drops. In most cases, drops are assigned various tiers of arbitrary rarity, with the highest tier rarities having the lowest percentage drop rates. This creates opportunity for players to spend money on in-game currency for the highest chance of obtaining the rarest items.</p>
<p>Gacha pools often look something like this, with similar semantic colors representing each of the rarities:</p>
<p><img src="/static/sekaictf-2023/gacha-pool.svg" alt="Gacha Pool"></p>
<p>Rolling on this banner provides a chance to receive a drop from each of the rarity tiers:</p>
<p><img src="/static/sekaictf-2023/gacha-model.svg" alt="Gacha Model"></p>
<p>This transformation from a simple toy capsule game catered towards younger children into a fully fledged business model has been subject to countless scrutiny and controversy, mainly due to its predatory monetization system and potential to develop gambling addictions within its playerbase. Many legal jurisdictions require gacha games to disclose the probability of obtaining each rarity tier (which will be important later in the challenge).</p>
<h3 id="“Pity”-Mechanics"><a href="#“Pity”-Mechanics" class="headerlink" title="“Pity” Mechanics"></a>“Pity” Mechanics</h3><p>Let’s also explain an important aspect of my challenge that’s a common pattern in gacha games: “pity”.</p>
<p>In a multitude of different gacha games, a “guaranteed drop” mechanic, colloquially referred to as a “pity”, exists for unlucky players who have rolled a certain amount of times without obtaining their desired drop. There are three types of pity systems that are typically used in gacha games: <strong>soft pity</strong>, <strong>hard pity</strong>, and <strong>soft&#x2F;hard pity</strong>. In soft pity, the chance to obtain a drop of the highest rarity increases with each pull. In hard pity, the player is guaranteed to obtain a drop of the highest rarity once the pull counter reaches a certain threshold. Soft&#x2F;hard pity is a hybrid of both of these mechanics.</p>
<p>Let’s take the gacha system of a popular gacha game as of writing, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Genshin_Impact">Genshin Impact</a>, as an example. As banners in this game utilize the soft&#x2F;hard pity system, the player is guaranteed to obtain a 5-star character after 90 pulls (hard pity), and the chance to obtain a 5-star character increases with each pull after 74 pulls (soft pity):</p>
<p><img src="/static/sekaictf-2023/genshin-pity.svg" alt="Genshin Impact Pity"></p>
<p>By increasing the chance to obtain a 5-star character with each pull, the player is more likely to obtain a 5-star character before the hard pity threshold is reached.</p>
<p>However, Project Sekai doesn’t utilize this system. It uses the simple “hard pity” system, with a small change: your pulls add to a “gacha bonus points” counter, which guarantees a 4-star and “pick-up” (featured character) 4-star at 50 and 100 pulls, respectively. You get 0.5 points for a pull using free currency, and 1 point for a pull using paid currency, illustrated as such in this diagram:</p>
<p><img src="/static/sekaictf-2023/project-sekai-gacha.svg" alt="Project Sekai Gacha"></p>
<p>For the sake of simplicity within the challenge, I decided to implement a <strong>pure hard pity</strong> system, where the rate of rolling characters is static, and a 4-star character is guaranteed after a certain amount of pulls.</p>
<h3 id="Considering-Challenge-Difficulty"><a href="#Considering-Challenge-Difficulty" class="headerlink" title="Considering Challenge Difficulty"></a>Considering Challenge Difficulty</h3><p>Learning from feedback in our survey last year, we (<a target="_blank" rel="noopener" href="https://sekai.team/">Project SEKAI CTF</a>) discovered that a lot of our players were actually beginners——over half of the playerbase that took the survey had less than 5 CTFs worth of experience under their belt:</p>
<p><img src="/static/sekaictf-2023/2022-pie-chart.svg" alt="SekaiCTF 2022 Pie Chart"></p>
<p>Combined with the fact we occasionally attract players from the Project Sekai community (a community which has absolutely nothing to do with cybersecurity), we decided that it would be best to design a beginner-friendly, eye-candy challenge that would attract a newer playerbase to register for our CTF and try the introductory challenges. This was a perfect opportunity for us to clone an aspect of the game that inspired our entire CTF theme, and to implement it in a way that would be engaging and educational for newer players. A Unity reverse engineering challenge would be the perfect fit, as plenty of Unity game-hacking resources exist online, and compiled Unity bundles are trivial to reverse-engineer and modify.</p>
<h2 id="Designing-the-Challenge-Brainstorming"><a href="#Designing-the-Challenge-Brainstorming" class="headerlink" title="Designing the Challenge: Brainstorming"></a>Designing the Challenge: Brainstorming</h2><p>Although “cloning” the game and its functionality might not be too brain-rotting of a process, we still have to design the challenge to be reverse-engineerable. Me and <a target="_blank" rel="noopener" href="https://twitter.com/sahuang97">@sahuang</a> ended up creating a design document which overviewed the challenge’s functionality, and the general path needed to take in order to solve it; here’s a TL;DR of the key points with some visuals.</p>
<div class="box" style="text-align: left; background-color: #1a1a1a;">The challenge will provide users with a Unity game bundle. The game will be a Project Sekai gacha emulator, and the goal is to pull a special 4* card (<code>Happy Birthday！！2023 - こはね 小豆沢</code>) to receive the flag.</div>

<p><img src="/static/sekaictf-2023/brainstorming-1.svg" alt="Brainstorming I"></p>
<div class="box" style="text-align: left; background-color: #1a1a1a;">Here are some basic details:
<ol>
<li>When starting the gacha, the player will have 100 crystals. There are two options available for the player to pick, but only one is available to them: the one-pull and the ten-pull (the available one being the former).</li>
<li>All of the characters available in the gacha pool will be the 2* and 3* variations of Kohane Azusawa.</li>
<li>The player can "hack" the game by modifying the crystal amount to continue rolling. However, the desired drop (<code>Happy Birthday！！2023 - こはね 小豆沢</code>) is <strong>rigged to be 0%</strong>. The only way to get the character is to pull 1,000,000 (one million) times to guarantee a drop through the "hard pity" system. Since this is evidently a time-inefficient process, they will need to find a way to change their pity counter.</li>
</ol></div>

<p><img src="/static/sekaictf-2023/brainstorming-2.svg" alt="Brainstorming II"></p>
<div class="box" style="text-align: left; background-color: #1a1a1a;">There will be a secret endpoint IP (obfuscated through simple base64) in one of the C# scripts. Each gacha 10-pull will actually send a <code>POST</code> request to the server with a payload. The players will need to both recognize this obfuscation and realize that a <code>POST</code> request is being made through reading the code.
The generic structure of the request includes:
<ul>
<li>A custom agent <code>SekaiCTF</code></li>
<li>The following JSON data:</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;crystals&quot;</span><span class="punctuation">:</span> <span class="number">5000</span><span class="punctuation">,</span> <span class="comment">// number of in-hand crystals</span></span><br><span class="line">  <span class="attr">&quot;pulls&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> <span class="comment">// number of pulls made in this game instance</span></span><br><span class="line">  <span class="attr">&quot;numPulls&quot;</span><span class="punctuation">:</span> <span class="number">10</span> <span class="comment">// meaning the user has selected a ten-pull</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
The endpoint will return:
<ul>
<li>A key-value pair <code>characters</code> containing an array of ten characters</li>
<li>If the character is the four-star rate-up character, an additional <code>flag: "[FLAG_IMAGE_HERE]"</code> key-value pair will be sent, containing a base64 encoding of an image containing the flag</li>
</ul></div>

<p>Here’s a verbose <code>curl</code> which demonstrates the request and response (of course, made after the challenge was deployed for the sake of demonstration):</p>
<div><figure class="highlight text" style="height: 400px; overflow: scroll; margin: 1rem 0; background-color: #1D1D1D;"><table><tr><td class="code"><pre style="white-space: pre-wrap; word-break: break-word;"><span style="color:#DC3958">$</span> curl -v -X POST -H "Content-Type: application/json" -H "User-Agent: SekaiCTF" -d '{"crystals": 3000, "pulls": 10, "numPulls": 10}' http://172.86.64.89:3000/gacha
Note: Unnecessary use of -X or --request, POST is already inferred.
*   Trying 172.86.64.89:3000...
* Connected to 172.86.64.89 (172.86.64.89) port 3000 (#0)
> POST /gacha HTTP/1.1
> Host: 172.86.64.89:3000
> Accept: */*
> Content-Type: application/json
> User-Agent: SekaiCTF
> Content-Length: 47
>
* Mark bundle as not supporting multiuse
< HTTP/1.1 200 OK
< Content-Type: application/json
< Date: Mon, 21 Aug 2023 03:48:32 GMT
< Connection: keep-alive
< Keep-Alive: timeout=5
< Content-Length: 1729
<
{"characters":[{"name":"こはね 小豆沢","cardName":"あったかキャンプスタイル","rarity":"2*","attribute":"Cute","splashArt":"warm-camping-style","avatar":"warm-camping-style-icon"},{"name":"こはね 小豆沢","cardName":"憂いの夜","rarity":"3*","attribute":"Pure","splashArt":"gloomy-night","avatar":"gloomy-night-icon"},{"name":"こはね 小豆沢","cardName":"プリティ
ブライズメイド","rarity":"2*","attribute":"Happy","splashArt":"pretty-bridesmaid","avatar":"pretty-bridesmaid-icon"},{"name":"こはね 小豆沢","cardName":"Vivid BAD SQUAD","rarity":"2*","attribute":"Mysterious","splashArt":"vivid-bad-squad","avatar":"vivid-bad-squad-icon"},{"name":"こはね 小豆沢","cardName":"あったかキャンプスタイル","rarity":"2*","attribute":"Cute","splashArt":"warm-camping-style","avatar":"warm-camping-style-icon"},{"name":"こはね 小豆沢","cardName":"プリティブライズメイド","rarity":"2*","attribute":"Happy","splashArt":"pretty-bridesmaid","avatar":"pretty-* Connection #0 to host 172.86.64.89 left intact
bridesmaid-icon"},{"name":"こはね 小豆沢","cardName":"Vivid BAD SQUAD","rarity":"2*","attribute":"Mysterious","splashArt":"vivid-bad-squad","avatar":"vivid-bad-squad-icon"},{"name":"こはね 小豆沢","cardName":"あったかキャンプスタイル","rarity":"2*","attribute":"Cute","splashArt":"warm-camping-style","avatar":"warm-camping-style-icon"},{"name":"こはね 小豆沢","cardName":"Vivid BAD SQUAD","rarity":"2*","attribute":"Mysterious","splashArt":"vivid-bad-squad","avatar":"vivid-bad-squad-icon"},{"name":"こはね 小豆沢","cardName":"あったかキャンプスタイル","rarity":"2*","attribute":"Cute","splashArt":"warm-camping-style","avatar":"warm-camping-style-icon"}]}</pre></td></tr></table></div>

<div class="box" style="text-align: left; background-color: #1a1a1a;">We will hint in the description that a million pulls is needed to achieve the goal through a "pity" system. To complete the challenge, the player can do either of these strategies:
<ul>
<li>Change the client-side value of either <code>pulls</code> or <code>crystals</code> to hit the 1,000,000 pity counter on the server</li>
<li>Send a <code>POST</code> request themselves to the obfuscated endpoint with the appropriate structure</li>
</ul>
The flag will be printed on the screen after a million pulls, regardless of whether or not the user modified the JSON or actually pulled a million times. If the user sends a <code>POST</code> request on their own, they will need to decode the image themselves.</div>

<p>This was all of the planning and designing that went into the actual challenge structure itself. It’s purposefully simple to make the reverse-engineering process as straightforward as possible, and to make the challenge more beginner-friendly. We can now go over how I created the backend server for the challenge.</p>
<h2 id="Implementing-the-Challenge-Backend"><a href="#Implementing-the-Challenge-Backend" class="headerlink" title="Implementing the Challenge: Backend"></a>Implementing the Challenge: Backend</h2><p>Since I’m really comfortable with vanilla TypeScript, I decided that it’d be best to use it to write the backend server (contrary to the typical Python Flask server in CTFs).</p>
<p>I created a <code>gacha.json</code>, which contains the entire pool of characters that we used. Since the entire challenge is themed around Kohane Azusawa, I utilized the pool from her 2023 birthday banner——the drop rates and characters are fully available on <a target="_blank" rel="noopener" href="https://sekai.best/gacha/302">sekai.best</a>‘s entry of the banner:</p>
<p><img src="/static/sekaictf-2023/sekai-best-pool.gif" alt="Sekai.best Pool"></p>
<p>Manually going through every entry listed in the database, I created the following JSON file:</p>
<div><figure class="highlight json" style="height: 400px; overflow: scroll; margin: 1rem 0;"><table><figcaption><span>[gacha.json] Gacha Pool Structure</span></figcaption><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="punctuation">{</span>
    <span class="attr">&quot;characters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;こはね 小豆沢&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;cardName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Vivid BAD SQUAD&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;rarity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2*&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;attribute&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mysterious&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;splashArt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vivid-bad-squad&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vivid-bad-squad-icon&quot;</span>
        <span class="punctuation">}</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;こはね 小豆沢&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;cardName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;想いをこめたシーグラス&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;rarity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2*&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;attribute&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cool&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;splashArt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sea-glass-full-of-feelings&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sea-glass-full-of-feelings-icon&quot;</span>
        <span class="punctuation">}</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;こはね 小豆沢&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;cardName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;あったかキャンプスタイル&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;rarity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2*&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;attribute&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cute&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;splashArt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;warm-camping-style&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;warm-camping-style-icon&quot;</span>
        <span class="punctuation">}</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;こはね 小豆沢&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;cardName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;プリティブライズメイド&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;rarity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2*&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;attribute&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Happy&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;splashArt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pretty-bridesmaid&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pretty-bridesmaid-icon&quot;</span>
        <span class="punctuation">}</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;こはね 小豆沢&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;cardName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;セカイで一息&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;rarity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3*&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;attribute&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cool&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;splashArt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a-quick-breather&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a-quick-breather-icon&quot;</span>
        <span class="punctuation">}</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;こはね 小豆沢&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;cardName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;憂いの夜&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;rarity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3*&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;attribute&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Pure&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;splashArt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gloomy-night&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gloomy-night-icon&quot;</span>
        <span class="punctuation">}</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;こはね 小豆沢&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;cardName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;レモネードで一休み♪&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;rarity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3*&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;attribute&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Happy&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;splashArt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lemonade-break&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lemonade-break-icon&quot;</span>
        <span class="punctuation">}</span><span class="punctuation">,</span>
        <span class="punctuation">{</span>
            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;こはね 小豆沢&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;cardName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Happy Birthday！！2023&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;rarity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4*&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;attribute&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mysterious&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;splashArt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;happy-birthday&quot;</span><span class="punctuation">,</span>
            <span class="attr">&quot;avatar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;happy-birthday-icon&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">]</span>
<span class="punctuation">}</span></pre></td></tr></table></div>

<p>The new TypeScript project I made utilized the <a target="_blank" rel="noopener" href="https://github.com/jsynowiec/node-typescript-boilerplate"><code>jsynowiec/node-typescript-boilerplate</code></a> repository, which (after some of my own additions and removals) resulted in this project structure:</p>
<div><figure class="highlight text" style="height: 400px; overflow: scroll; margin: 1rem 0; background-color: #1D1D1D;"><table><tr><td class="code"><pre><span style="color:#DC3958">$</span> git ls-tree -r --name-only HEAD | tree --fromfile
.
├── .editorconfig
├── .eslintignore
├── .eslintrc.json
├── .gitignore
├── .prettierrc
├── Dockerfile
├── <span style="font-weight:bold;color:#3B78FF">__tests__</span>
│   └── main.test.ts
├── cleanup.sh
├── jest.config.js
├── package-lock.json
├── package.json
├── <span style="font-weight:bold;color:#3B78FF">src</span>
│   ├── <span style="font-weight:bold;color:#B4009E">flag.png</span>
│   ├── gacha.json
│   └── interfaces.ts
│   └── main.ts
├── start.sh
├── tsconfig.json
└── tsconfig.release.json</pre></td></tr></table></div>

<p>Here is <code>src/main.ts</code>, the main entrypoint of the server and the place where the pity system, gacha pool, and endpoint are implemented:</p>
<div><figure class="highlight typescript" style="height: 400px; overflow: scroll; margin: 1rem 0;"><table><figcaption><span>[src/main.ts] Main Backend Script</span></figcaption><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="keyword">import</span> * <span class="keyword">as</span> http <span class="keyword">from</span> <span class="string">&#x27;http&#x27;</span>
<span class="keyword">import</span> * <span class="keyword">as</span> url <span class="keyword">from</span> <span class="string">&#x27;url&#x27;</span>
<span class="keyword">import</span> * <span class="keyword">as</span> fs <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>
<span class="keyword">import</span> { <span class="title class_">GachaResponse</span> } <span class="keyword">from</span> <span class="string">&#x27;./interfaces.js&#x27;</span>

<span class="keyword">const</span> <span class="variable constant_">PORT</span> = <span class="number">3000</span>

<span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;src/gacha.json&#x27;</span>, <span class="string">&#x27;utf8&#x27;</span>))
<span class="keyword">const</span> characters = data.<span class="property">characters</span>
<span class="keyword">const</span> probabilities = [<span class="number">0</span>, <span class="number">0.915</span>, <span class="number">0.085</span>, <span class="number">0</span>]


<span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> {
    <span class="keyword">if</span> (req.<span class="property">url</span> === <span class="literal">undefined</span>) {
        res.<span class="property">statusCode</span> = <span class="number">400</span>
        res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain&#x27;</span>)
        res.<span class="title function_">end</span>(<span class="string">&#x27;Invalid URL&#x27;</span>)
        <span class="keyword">return</span>
    }

    <span class="keyword">const</span> reqUrl = url.<span class="title function_">parse</span>(req.<span class="property">url</span>, <span class="literal">true</span>)

    <span class="keyword">if</span> (req.<span class="property">method</span> === <span class="string">&#x27;POST&#x27;</span> &amp;&amp; reqUrl.<span class="property">pathname</span> === <span class="string">&#x27;/gacha&#x27;</span>) {
        <span class="keyword">if</span> (req.<span class="property">headers</span>[<span class="string">&#x27;user-agent&#x27;</span>] !== <span class="string">&#x27;SekaiCTF&#x27;</span>) {
            res.<span class="property">statusCode</span> = <span class="number">400</span>
            res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain&#x27;</span>)
            res.<span class="title function_">end</span>(<span class="string">&#x27;Invalid User-Agent&#x27;</span>)
            <span class="keyword">return</span>
        }

        <span class="keyword">let</span> body = <span class="string">&#x27;&#x27;</span>
        req.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> {
            body += chunk.<span class="title function_">toString</span>()
        })

        req.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> {
            <span class="keyword">const</span> { crystals, pulls, numPulls } = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(body)
            <span class="keyword">if</span> (
                <span class="keyword">typeof</span> crystals !== <span class="string">&#x27;number&#x27;</span> ||
                <span class="keyword">typeof</span> pulls !== <span class="string">&#x27;number&#x27;</span> ||
                <span class="keyword">typeof</span> numPulls !== <span class="string">&#x27;number&#x27;</span>
            ) {
                res.<span class="property">statusCode</span> = <span class="number">400</span>
                res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/json&#x27;</span>)
                res.<span class="title function_">end</span>(
                    <span class="title class_">JSON</span>.<span class="title function_">stringify</span>({ <span class="attr">error</span>: <span class="string">&#x27;ERROR: Invalid request body!&#x27;</span> })
                )
                <span class="keyword">return</span>
            }

            <span class="keyword">const</span> costPerPull = <span class="number">100</span>
            <span class="keyword">const</span> totalCost = costPerPull * numPulls
            <span class="keyword">if</span> (crystals &lt; totalCost) {
                res.<span class="property">statusCode</span> = <span class="number">400</span>
                res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/json&#x27;</span>)
                res.<span class="title function_">end</span>(
                    <span class="title class_">JSON</span>.<span class="title function_">stringify</span>({ <span class="attr">error</span>: <span class="string">&#x27;ERROR: Not enough crystals!&#x27;</span> })
                )
                <span class="keyword">return</span>
            }

            <span class="keyword">if</span> (numPulls !== <span class="number">1</span> &amp;&amp; numPulls !== <span class="number">10</span>) {
                res.<span class="property">statusCode</span> = <span class="number">400</span>
                res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/json&#x27;</span>)
                res.<span class="title function_">end</span>(
                    <span class="title class_">JSON</span>.<span class="title function_">stringify</span>({
                        <span class="attr">error</span>: <span class="string">&#x27;ERROR: numPulls can only be 1 or 10!&#x27;</span>,
                    })
                )
                <span class="keyword">return</span>
            }

            <span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">GachaResponse</span> = {
                <span class="attr">characters</span>: [],
            }

            <span class="keyword">let</span> totalPulls = pulls % <span class="number">1000000</span>

            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; numPulls; i++) {
                <span class="keyword">let</span> rarity = <span class="number">0</span>

                totalPulls += <span class="number">1</span>

                <span class="keyword">if</span> (totalPulls &gt;= <span class="number">1000000</span>) {
                    rarity = <span class="number">4</span>
                    totalPulls -= <span class="number">1000000</span>

                    <span class="keyword">const</span> pool = characters.<span class="title function_">filter</span>(
                        <span class="function">(<span class="params">character</span>) =&gt;</span> character.<span class="property">rarity</span> === <span class="string">`<span class="subst">${rarity}</span>*`</span>
                    )

                    <span class="keyword">const</span> characterIndex = <span class="title class_">Math</span>.<span class="title function_">floor</span>(
                        <span class="title class_">Math</span>.<span class="title function_">random</span>() * pool.<span class="property">length</span>
                    )

                    <span class="keyword">const</span> imageBuffer = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;src/flag.png&#x27;</span>)

                    result.<span class="property">characters</span>.<span class="title function_">push</span>({
                        ...pool[characterIndex],
                        <span class="attr">flag</span>: imageBuffer.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>),
                    })

                    <span class="keyword">continue</span>
                } <span class="keyword">else</span> {
                    <span class="keyword">let</span> rand = <span class="title class_">Math</span>.<span class="title function_">random</span>()
                    <span class="keyword">let</span> index = <span class="number">0</span>
                    <span class="keyword">while</span> (rand &gt; probabilities[index]) {
                        rand -= probabilities[index]
                        index++
                    }
                    rarity = index + <span class="number">1</span>
                }

                <span class="keyword">const</span> pool = characters.<span class="title function_">filter</span>(
                    <span class="function">(<span class="params">character</span>) =&gt;</span> character.<span class="property">rarity</span> === <span class="string">`<span class="subst">${rarity}</span>*`</span>
                )

                <span class="keyword">const</span> characterIndex = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * pool.<span class="property">length</span>)

                result.<span class="property">characters</span>.<span class="title function_">push</span>(pool[characterIndex])
            }

            res.<span class="property">statusCode</span> = <span class="number">200</span>
            res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/json&#x27;</span>)
            res.<span class="title function_">end</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(result))
        })
    } <span class="keyword">else</span> {
        res.<span class="property">statusCode</span> = <span class="number">404</span>
        res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain&#x27;</span>)
        res.<span class="title function_">end</span>(<span class="string">&#x27;Not Found&#x27;</span>)
    }
})

server.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="function">() =&gt;</span> {
    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Server listening on port <span class="subst">${PORT}</span>`</span>)
})

<span class="keyword">export</span> <span class="keyword">default</span> server</pre></td></tr></table></div>

<p>We can see that at exactly the one millionth pull sent to the server, the flag is sent back to the client in the form of a key-value pair (containing an image encoded with base64) within the special rate-up character’s object.</p>
<p>Testing this endpoint was made buttery smooth with the help of <a target="_blank" rel="noopener" href="https://jestjs.io/">Jest</a>; I made a test suite in <code>__tests__/main.test.ts</code> which sent a variety of different inputs, and made sure that a correct response was being outputted:</p>
<div><figure class="highlight typescript" style="height: 400px; overflow: scroll; margin: 1rem 0;"><table><figcaption><span>[__tests__/main.test.ts] Jest Test Suite</span></figcaption><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="keyword">import</span> server <span class="keyword">from</span> <span class="string">&#x27;../src/main.js&#x27;</span>
<span class="keyword">import</span> * <span class="keyword">as</span> http <span class="keyword">from</span> <span class="string">&#x27;http&#x27;</span>
<span class="keyword">import</span> { <span class="title class_">GachaResponse</span> } <span class="keyword">from</span> <span class="string">&#x27;../src/interfaces.js&#x27;</span>

<span class="title function_">describe</span>(<span class="string">&#x27;Gacha endpoint&#x27;</span>, <span class="function">() =&gt;</span> {
    <span class="keyword">let</span> <span class="attr">req</span>: http.<span class="property">ClientRequest</span>

    <span class="title function_">afterAll</span>(<span class="function">() =&gt;</span> {
        server.<span class="title function_">close</span>()
    })

    <span class="title function_">afterEach</span>(<span class="function">() =&gt;</span> {
        req.<span class="title function_">abort</span>()
    })

    <span class="keyword">function</span> <span class="title function_">testGachaEndpoint</span>(<span class="params">
        crystals: <span class="built_in">number</span>,
        pulls: <span class="built_in">number</span>,
        numPulls: <span class="built_in">number</span>
    </span>): <span class="title class_">Promise</span>&lt;{ <span class="attr">res</span>: http.<span class="property">IncomingMessage</span>; <span class="attr">data</span>: <span class="title class_">GachaResponse</span> }&gt; {
        <span class="keyword">const</span> postData = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>({ crystals, pulls, numPulls })
        <span class="keyword">const</span> options = {
            <span class="attr">hostname</span>: <span class="string">&#x27;localhost&#x27;</span>,
            <span class="attr">port</span>: <span class="number">3000</span>,
            <span class="attr">path</span>: <span class="string">&#x27;/gacha&#x27;</span>,
            <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,
            <span class="attr">headers</span>: {
                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,
                <span class="string">&#x27;Content-Length&#x27;</span>: <span class="title class_">Buffer</span>.<span class="title function_">byteLength</span>(postData),
                <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;SekaiCTF&#x27;</span>,
            },
        }
        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;{ <span class="attr">res</span>: http.<span class="property">IncomingMessage</span>; <span class="attr">data</span>: <span class="title class_">GachaResponse</span> }&gt;(
            <span class="function">(<span class="params">resolve</span>) =&gt;</span> {
                req = http.<span class="title function_">request</span>(options, <span class="function">(<span class="params">res</span>) =&gt;</span> {
                    <span class="keyword">let</span> data = <span class="string">&#x27;&#x27;</span>
                    res.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> {
                        data += chunk
                    })
                    res.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> {
                        <span class="title function_">resolve</span>({ res, <span class="attr">data</span>: <span class="title class_">JSON</span>.<span class="title function_">parse</span>(data) })
                    })
                })
                req.<span class="title function_">write</span>(postData)
                req.<span class="title function_">end</span>()
            }
        )
    }

    <span class="title function_">it</span>(<span class="string">&#x27;should return a valid response for ten pulls&#x27;</span>, <span class="keyword">async</span> () =&gt; {
        <span class="keyword">const</span> { res, data } = <span class="keyword">await</span> <span class="title function_">testGachaEndpoint</span>(<span class="number">1000</span>, <span class="number">0</span>, <span class="number">10</span>)
        <span class="title function_">expect</span>(res.<span class="property">statusCode</span>).<span class="title function_">toBe</span>(<span class="number">200</span>)
        <span class="title function_">expect</span>(data).<span class="title function_">toBeDefined</span>()
    })

    <span class="title function_">it</span>(<span class="string">&#x27;should return an array of ten characters if the user has enough gems for ten pulls&#x27;</span>, <span class="keyword">async</span> () =&gt; {
        <span class="keyword">const</span> { res, data } = <span class="keyword">await</span> <span class="title function_">testGachaEndpoint</span>(<span class="number">1000</span>, <span class="number">0</span>, <span class="number">10</span>)
        <span class="title function_">expect</span>(res.<span class="property">statusCode</span>).<span class="title function_">toBe</span>(<span class="number">200</span>)
        <span class="title function_">expect</span>(data.<span class="property">characters</span>).<span class="title function_">toHaveLength</span>(<span class="number">10</span>)
    })

    <span class="title function_">it</span>(<span class="string">&#x27;should show the flag if the user has 1,000,000 pulls&#x27;</span>, <span class="keyword">async</span> () =&gt; {
        <span class="keyword">const</span> { res, data } = <span class="keyword">await</span> <span class="title function_">testGachaEndpoint</span>(<span class="number">1000</span>, <span class="number">999999</span>, <span class="number">1</span>)
        <span class="title function_">expect</span>(res.<span class="property">statusCode</span>).<span class="title function_">toBe</span>(<span class="number">200</span>)
        <span class="title function_">expect</span>(data.<span class="property">characters</span>[<span class="number">0</span>].<span class="property">flag</span>).<span class="title function_">toBeDefined</span>()
    })

    <span class="title function_">it</span>(<span class="string">&#x27;should return an error if numPulls is not either 1 or 10&#x27;</span>, <span class="keyword">async</span> () =&gt; {
        <span class="keyword">const</span> { res, data } = <span class="keyword">await</span> <span class="title function_">testGachaEndpoint</span>(<span class="number">1100</span>, <span class="number">0</span>, <span class="number">11</span>)
        <span class="title function_">expect</span>(res.<span class="property">statusCode</span>).<span class="title function_">toBe</span>(<span class="number">400</span>)
        <span class="title function_">expect</span>(data.<span class="property">error</span>).<span class="title function_">toBe</span>(<span class="string">&#x27;ERROR: numPulls can only be 1 or 10!&#x27;</span>)
    })

    <span class="title function_">it</span>(<span class="string">&#x27;should return an error if the user does not have enough gems for ten pulls&#x27;</span>, <span class="keyword">async</span> () =&gt; {
        <span class="keyword">const</span> { res, data } = <span class="keyword">await</span> <span class="title function_">testGachaEndpoint</span>(<span class="number">999</span>, <span class="number">0</span>, <span class="number">10</span>)
        <span class="title function_">expect</span>(res.<span class="property">statusCode</span>).<span class="title function_">toBe</span>(<span class="number">400</span>)
        <span class="title function_">expect</span>(data.<span class="property">error</span>).<span class="title function_">toBe</span>(<span class="string">&#x27;ERROR: Not enough crystals!&#x27;</span>)
    })

    <span class="title function_">it</span>(<span class="string">&#x27;should return an error if the return body is incomplete&#x27;</span>, <span class="keyword">async</span> () =&gt; {
        <span class="keyword">const</span> { res, data } = <span class="keyword">await</span> <span class="title function_">testGachaEndpoint</span>(<span class="number">1000</span>, <span class="literal">undefined</span>, <span class="number">10</span>)
        <span class="title function_">expect</span>(res.<span class="property">statusCode</span>).<span class="title function_">toBe</span>(<span class="number">400</span>)
        <span class="title function_">expect</span>(data.<span class="property">error</span>).<span class="title function_">toBe</span>(<span class="string">&#x27;ERROR: Invalid request body!&#x27;</span>)
    })

    <span class="title function_">it</span>(<span class="string">&#x27;should return a valid response for a single pull&#x27;</span>, <span class="keyword">async</span> () =&gt; {
        <span class="keyword">const</span> { res, data } = <span class="keyword">await</span> <span class="title function_">testGachaEndpoint</span>(<span class="number">100</span>, <span class="number">0</span>, <span class="number">1</span>)
        <span class="title function_">expect</span>(res.<span class="property">statusCode</span>).<span class="title function_">toBe</span>(<span class="number">200</span>)
        <span class="title function_">expect</span>(data).<span class="title function_">toBeDefined</span>()
    })

    <span class="title function_">it</span>(<span class="string">&#x27;should return an array of one character if the user has enough gems for a single pull&#x27;</span>, <span class="keyword">async</span> () =&gt; {
        <span class="keyword">const</span> { res, data } = <span class="keyword">await</span> <span class="title function_">testGachaEndpoint</span>(<span class="number">100</span>, <span class="number">0</span>, <span class="number">1</span>)
        <span class="title function_">expect</span>(res.<span class="property">statusCode</span>).<span class="title function_">toBe</span>(<span class="number">200</span>)
        <span class="title function_">expect</span>(data.<span class="property">characters</span>).<span class="title function_">toHaveLength</span>(<span class="number">1</span>)
    })

    <span class="title function_">it</span>(<span class="string">&#x27;should return an error if the user does not have enough gems for a single pull&#x27;</span>, <span class="keyword">async</span> () =&gt; {
        <span class="keyword">const</span> { res, data } = <span class="keyword">await</span> <span class="title function_">testGachaEndpoint</span>(<span class="number">99</span>, <span class="number">0</span>, <span class="number">1</span>)
        <span class="title function_">expect</span>(res.<span class="property">statusCode</span>).<span class="title function_">toBe</span>(<span class="number">400</span>)
        <span class="title function_">expect</span>(data.<span class="property">error</span>).<span class="title function_">toBe</span>(<span class="string">&#x27;ERROR: Not enough crystals!&#x27;</span>)
    })
})</pre></td></tr></table></div>

<p>These tests were a godsend after breaking changes to ensure code functionality was as expected:</p>
<div><figure class="highlight text" style="background-color: #1D1D1D;"><table><tr><td class="code"><pre><span style="color:#DC3958">$</span> npm run test 

> gacha-backend@0.0.0 test
> node --experimental-vm-modules node_modules/jest/bin/jest.js

  <span style="color:#656565">console.log</span>
    Server listening on port 3000

      <span style="color:#656565">at Server.&lt;anonymous&gt; (src/main.ts:150:13)</span>

<span style="background-color:#0DBC79;color:#656565"> PASS </span> <span style="color:#656565">__tests__/</span><span style="font-weight:bold">main.test.ts</span>
  Gacha endpoint
    <span style="color:#0DBC79">√</span> <span style="color:#656565">should return a valid response for ten pulls (51 ms)</span>
    <span style="color:#0DBC79">√</span> <span style="color:#656565">should return an array of ten characters if the user has enough gems for ten pulls (6 ms)</span>
    <span style="color:#0DBC79">√</span> <span style="color:#656565">should show the flag if the user has 1,000,000 pulls (9 ms)</span>
    <span style="color:#0DBC79">√</span> <span style="color:#656565">should return an error if numPulls is not either 1 or 10 (7 ms)</span>
    <span style="color:#0DBC79">√</span> <span style="color:#656565">should return an error if the user does not have enough gems for ten pulls (6 ms)</span>
    <span style="color:#0DBC79">√</span> <span style="color:#656565">should return an error if the return body is incomplete (6 ms)</span>
    <span style="color:#0DBC79">√</span> <span style="color:#656565">should return a valid response for a single pull (7 ms)</span>
    <span style="color:#0DBC79">√</span> <span style="color:#656565">should return an array of one character if the user has enough gems for a single pull (5 ms)</span>
    <span style="color:#0DBC79">√</span> <span style="color:#656565">should return an error if the user does not have enough gems for a single pull (7 ms)</span>

<b>Test Suites:</b> <span style="color:#0DBC79;font-weight:bold">1 passed</span>, 1 total
<b>Tests:</b>       <span style="color:#0DBC79;font-weight:bold">9 passed</span>, 9 total
<b>Snapshots:</b>   0 total
<b>Time:</b>        2.118 s, estimated 3 s
<span style="color:#656565">Ran all test suites.</span></pre></td></tr></table></div>

<p>Beautiful! We finished off the backend by deploying to <a target="_blank" rel="noopener" href="https://cloudzy.com/">Cloudzy</a> (our captain had an egregious sum of free credits), which gave us a suspicious raw IP that surely would draw attention while looking through the challenge files.</p>
<p>Let’s talk about the Unity graphics next.</p>
<h2 id="Replicating-UI-Elements-with-Figma"><a href="#Replicating-UI-Elements-with-Figma" class="headerlink" title="Replicating UI Elements with Figma"></a>Replicating UI Elements with Figma</h2><p>I wanted to make the game look as polished and as similar to the real product as possible, so I began by recreating and grabbing all of the assets that the game used in the gacha page. I found a bunch of YouTube videos which provided a nice overview of what the in-game screen looked like:</p>
<p><img src="/static/sekaictf-2023/example-screen.png" alt="Example Screen"></p>
<p>Unfortunately, there weren’t any datamines&#x2F;rips of Project Sekai that I could find which contained my desired UI elements, and I had to remake them from scratch in graphic design software——I used <a target="_blank" rel="noopener" href="https://figma.com/">Figma</a> throughout this entire process.</p>
<p>Since this project was meant to replicate, not innovate, a lot of the design process was just me eyeballing the elements and trying to recreate them as accurately as possible——the hardest part, honestly, was finding the fonts which were used in-game. I scoured the internet for any available resources regarding this to no avail, and used various font detection&#x2F;scanning software on in-game screenshots (which, of course, yielded incorrect results).</p>
<p>Luckily, <a target="_blank" rel="noopener" href="https://github.com/blueset">@blueset</a>, my team’s co-founder, happens to be a massive typography enjoyer, and quickly directed me to one of his old tweets:</p>
<div class="twitter-wrapper"><blockquote class="twitter-tweet tw-align-center" data-theme="dark" style="width: 400"><a target="_blank" rel="noopener" href="https://twitter.com/blueset/status/1432534617609932800"></a></blockquote></div><script async="" defer="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>The first font on this list, ロダンNTLG DB (Rodin New Type Labo Gothic), was the font used for nearly all UI-based text elements in-game:</p>
<p><img src="/static/sekaictf-2023/rodin-font.png" alt="Rodin Font"></p>
<p>Of course, the <a target="_blank" rel="noopener" href="https://archive.org/download/Fontworks/">Internet Archive</a> has a directory listing of almost every Fontworks font, which I used to grab Rodin’s <code>.otf</code>. With this knowledge in-hand, I was able to recreate the UI elements with ease:</p>
<p><img src="/static/sekaictf-2023/figma-screenshot.png" alt="Figma Screenshot"></p>
<p><img src="/static/sekaictf-2023/figma-project.png" alt="Figma Project"></p>
<p>All elements that I were unable to recreate due to complexity (like the character attribute icons, star rarities, banner logos, etc.) I grabbed from online wikis (e.g. <a target="_blank" rel="noopener" href="https://projectsekai.fandom.com/wiki/Project_SEKAI_Wiki">Fandom</a>, <a target="_blank" rel="noopener" href="https://www.sekaipedia.org/wiki/Category:Game_assets">Sekaipedia</a>) of the game. With this undoubtedly important step out of the way, let’s talk about the Unity game itself.</p>
<h2 id="Implementing-the-Challenge-Unity"><a href="#Implementing-the-Challenge-Unity" class="headerlink" title="Implementing the Challenge: Unity"></a>Implementing the Challenge: Unity</h2><p>Of course, I’m no professional Unity game developer——I’ve only ever made a few major 2D projects in the past, and I’ve only touched the engine’s 3D components before once (my Unity challenge from last year, <a target="_blank" rel="noopener" href="https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/reverse/perfect-match-xtreme/Challenge">reverse&#x2F;Perfect Match X-treme</a>). However, I was confident that I would be able to emulate the appearance and functionality of the gacha system with a bit of graphic design knowledge and some janky code.</p>
<p>My Unity 2D (2021.3.29f1) project was honestly just a bunch of Canvas elements layered on top of each other. Of course, there’s a million better ways to do this (e.g. the new Unity UI Toolkit with dynamic modals&#x2F;buttons), but since this challenge was never meant to be long-term&#x2F;scalable I didn’t want to overcomplexify. Here is the hierarchy structure from within the editor:</p>
<p><img src="/static/sekaictf-2023/unity-hierarchy.png" alt="Unity Hierarchy"></p>
<p>You can easily observe which GameObjects become visible&#x2F;invisible throughout play; I created a GIF to demonstrate this in action:</p>
<p><img src="/static/sekaictf-2023/unity-layers.gif" alt="Unity Layers"></p>
<p>For this section of the blog post, I’ll be going over each individual script located within <code>Assets/Scripts</code>——conveniently, structuring the post in this manner actually fleshes out a lot of my challenge’s functionality, and places the various scripts in context for later when we talk about reverse-engineering. Each script will have its own dedicated section, ordered by how important I believe they are. Let’s get started!</p>
<hr>
<h3 id="GachaManager-cs"><a href="#GachaManager-cs" class="headerlink" title="GachaManager.cs"></a><code>GachaManager.cs</code></h3><p>Of course, in order for the entire gacha system to function, we needed a script which would facilitate interacting with the backend server. This script is responsible for crafting and sending the proper <code>POST</code> request to the server, and delegating the parsed response to the <code>UIManager.cs</code> script for display. We first define a <code>RequestClasses</code> namespace, which defines the structure of the JSON payloads that we will be sending&#x2F;receiving:</p>
<div><figure class="highlight csharp" style="height: 400px; overflow: scroll; margin: 1rem 0;"><table><figcaption><span>Asset/Scripts/RequestClasses.cs</span></figcaption><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="keyword">namespace</span> <span class="title">RequestClasses</span>
{
    [<span class="meta">System.Serializable</span>]
    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GachaRequest</span>
    {
        <span class="keyword">public</span> <span class="built_in">int</span> crystals;
        <span class="keyword">public</span> <span class="built_in">int</span> pulls;
        <span class="keyword">public</span> <span class="built_in">int</span> numPulls;

        <span class="function"><span class="keyword">public</span> <span class="title">GachaRequest</span>(<span class="params"><span class="built_in">int</span> crystals, <span class="built_in">int</span> pulls, <span class="built_in">int</span> numPulls</span>)</span>
        {
            <span class="keyword">this</span>.crystals = crystals;
            <span class="keyword">this</span>.pulls = pulls;
            <span class="keyword">this</span>.numPulls = numPulls;
        }
    }

    [<span class="meta">System.Serializable</span>]
    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GachaResponse</span>
    {
        <span class="keyword">public</span> Character[] characters;
    }

    [<span class="meta">System.Serializable</span>]
    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Character</span>
    {
        <span class="keyword">public</span> <span class="built_in">string</span> name;
        <span class="keyword">public</span> <span class="built_in">string</span> cardName;
        <span class="keyword">public</span> <span class="built_in">string</span> rarity;
        <span class="keyword">public</span> <span class="built_in">string</span> attribute;
        <span class="keyword">public</span> <span class="built_in">string</span> splashArt;
        <span class="keyword">public</span> <span class="built_in">string</span> avatar;
        <span class="keyword">public</span> <span class="built_in">string</span> flag;
    }
}</pre></td></tr></table></div>

<p>We can utilize these in the main script to create a new <code>GachaRequest</code> object, which will be converted into a <code>UnityWebRequest</code> and properly handled:</p>
<div><figure class="highlight csharp" style="height: 400px; overflow: scroll; margin: 1rem 0;"><table><figcaption><span>Asset/Scripts/GachaManager.cs</span></figcaption><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="keyword">using</span> System.Collections;
<span class="keyword">using</span> UnityEngine;
<span class="keyword">using</span> UnityEngine.Networking;
<span class="keyword">using</span> RequestClasses;
<span class="keyword">using</span> System;

<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GachaManager</span> : <span class="title">MonoBehaviour</span>
{
    <span class="keyword">public</span> UIManager uiManager;
    <span class="keyword">public</span> GachaResponse lastGachaResponse;

    <span class="keyword">private</span> GameState gameState;

    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span>
    {
        gameState = FindObjectOfType&lt;GameState&gt;();
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnPullButtonClick</span>(<span class="params"><span class="built_in">int</span> cost, <span class="built_in">int</span> numPulls</span>)</span>
    {
        <span class="keyword">if</span> (gameState.crystals &lt; cost)
        {
            <span class="keyword">return</span>;
        }

        StartCoroutine(SendGachaRequest(numPulls));
    }

    <span class="function"><span class="keyword">public</span> IEnumerator <span class="title">SendGachaRequest</span>(<span class="params"><span class="built_in">int</span> numPulls</span>)</span>
    {
        GachaRequest gachaRequest = <span class="keyword">new</span> GachaRequest(gameState.crystals, gameState.pulls, numPulls);
        <span class="built_in">string</span> json = JsonUtility.ToJson(gachaRequest);

        <span class="keyword">using</span> (UnityWebRequest request = CreateGachaWebRequest(json))
        {
            <span class="keyword">yield</span> <span class="keyword">return</span> request.SendWebRequest();

            <span class="keyword">if</span> (request.result == UnityWebRequest.Result.Success)
            {
                HandleGachaResponse(request.downloadHandler.text, numPulls);
                GachaResponse response = JsonUtility.FromJson&lt;GachaResponse&gt;(
                    request.downloadHandler.text
                );
                StartCoroutine(uiManager.DisplaySplashArt(response.characters));
            }
            <span class="keyword">else</span>
            {
                uiManager.GenericModalHandler(
                    uiManager.failedConnectionModal,
                    uiManager.failedConnectionModalCloseButton
                );
                AudioController.Instance.PlaySFX(<span class="string">&quot;Open&quot;</span>);
            }
        }
    }

    <span class="function">UnityWebRequest <span class="title">CreateGachaWebRequest</span>(<span class="params"><span class="built_in">string</span> json</span>)</span>
    {
        <span class="built_in">byte</span>[] bodyRaw = System.Text.Encoding.UTF8.GetBytes(json);
        <span class="built_in">string</span> requestUrl = <span class="string">&quot;aHR0cDovLzE3Mi44Ni42NC44OTozMDAwL2dhY2hh&quot;</span>;

        UnityWebRequest request = <span class="keyword">new</span> UnityWebRequest(
            System.Text.Encoding.UTF8.GetString(Convert.FromBase64String(requestUrl)),
            <span class="string">&quot;POST&quot;</span>
        );
        request.uploadHandler = <span class="keyword">new</span> UploadHandlerRaw(bodyRaw);
        request.downloadHandler = <span class="keyword">new</span> DownloadHandlerBuffer();
        request.SetRequestHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>);
        request.SetRequestHeader(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;SekaiCTF&quot;</span>);

        <span class="keyword">return</span> request;
    }

    <span class="function"><span class="keyword">void</span> <span class="title">HandleGachaResponse</span>(<span class="params"><span class="built_in">string</span> responseText, <span class="built_in">int</span> numPulls</span>)</span>
    {
        GachaResponse response = JsonUtility.FromJson&lt;GachaResponse&gt;(responseText);
        lastGachaResponse = response;

        gameState.SpendCrystals(numPulls);
        uiManager.UpdateUI();
        uiManager.splashArtCanvas.gameObject.SetActive(<span class="literal">true</span>);
        AudioController.Instance.FadeMusic(<span class="string">&quot;Pulling&quot;</span>);
    }
}</pre></td></tr></table></div>

<p>Notice this extremely suspicious string near the bottom of the script:</p>
<div><figure class="highlight csharp" style="height: 400px; overflow: scroll; margin: 1rem 0;"><table><tr><td class="gutter"><pre><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="function">UnityWebRequest <span class="title">CreateGachaWebRequest</span>(<span class="params"><span class="built_in">string</span> json</span>)</span>
{
    <span class="built_in">byte</span>[] bodyRaw = System.Text.Encoding.UTF8.GetBytes(json);
<div class="diff-highlight-add">    <span class="built_in">string</span> requestUrl = <span class="string">&quot;aHR0cDovLzE3Mi44Ni42NC44OTozMDAwL2dhY2hh&quot;</span>;</div>

    UnityWebRequest request = <span class="keyword">new</span> UnityWebRequest(
        System.Text.Encoding.UTF8.GetString(Convert.FromBase64String(requestUrl)),
        <span class="string">&quot;POST&quot;</span>
    );
    request.uploadHandler = <span class="keyword">new</span> UploadHandlerRaw(bodyRaw);
    request.downloadHandler = <span class="keyword">new</span> DownloadHandlerBuffer();
    request.SetRequestHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>);
    request.SetRequestHeader(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;SekaiCTF&quot;</span>);

    <span class="keyword">return</span> request;
}</pre></td></tr></table></div>

<p>This obvious base64 obfuscation is the endpoint IP that we talked about earlier, which is decoded before being passed into the <code>new UnityWebRequest</code>. This is particularly catered towards newer players——it’s honestly like a sore thumb sticking out of the script, meant to be noticed and questioned.</p>
<p>Other than this, the script is pretty straightforward——if the request fails (due to bad internet, downed server, malformed payload, etc.), <code>uiManager.GenericModalHandler()</code> is called and displays <code>failedConnectionModal</code>:</p>
<div><figure class="highlight csharp" style=""><table><tr><td class="gutter"><pre><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="keyword">else</span>
{
    uiManager.GenericModalHandler(
        uiManager.failedConnectionModal,
        uiManager.failedConnectionModalCloseButton
    );
    AudioController.Instance.PlaySFX(<span class="string">&quot;Open&quot;</span>);
}</pre></td></tr></table></div>

<p><img src="/static/sekaictf-2023/error-modal.png" alt="Error Modal"></p>
<blockquote>
<p>接続エラー： サーバーに接続できませんでした (または不正なペイロー ドが送信されました!) 通貨は使われていません。<br>Connection Error: could not connect to the server (or an invalid payload was sent)! No currency was spent.</p>
</blockquote>
<p>Otherwise, if the request succeeds, responsibility for the data is delegated to the <code>uiManager.DisplaySplashArt()</code> coroutine:</p>
<div><figure class="highlight csharp" style=""><table><tr><td class="gutter"><pre><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><div style="margin:1.2em 0"><span class="line"> </span></div><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre>            <span class="keyword">if</span> (request.result == UnityWebRequest.Result.Success)
            {
                HandleGachaResponse(request.downloadHandler.text, numPulls);
                GachaResponse response = JsonUtility.FromJson&lt;GachaResponse&gt;(
                    request.downloadHandler.text
                );
<div class="diff-highlight-add">                StartCoroutine(uiManager.DisplaySplashArt(response.characters));</div>
            }
<div class="skip-highlight">46-73</div>
    <span class="function"><span class="keyword">void</span> <span class="title">HandleGachaResponse</span>(<span class="params"><span class="built_in">string</span> responseText, <span class="built_in">int</span> numPulls</span>)</span>
    {
        GachaResponse response = JsonUtility.FromJson&lt;GachaResponse&gt;(responseText);
        lastGachaResponse = response;

        gameState.SpendCrystals(numPulls);
        uiManager.UpdateUI();
        uiManager.splashArtCanvas.gameObject.SetActive(<span class="literal">true</span>);
        AudioController.Instance.FadeMusic(<span class="string">&quot;Pulling&quot;</span>);
    }</pre></td></tr></table></div>

<hr>
<h3 id="GameState-cs"><a href="#GameState-cs" class="headerlink" title="GameState.cs"></a><code>GameState.cs</code></h3><p>Although bite-sized in comparison to the other scripts, this script is responsible for maintaining the state of the game——the amount of crystals the player has and the amount of pulls they’ve made in the current session:</p>
<div><figure class="highlight csharp" style="height: 400px; overflow: scroll; margin: 1rem 0;"><table><figcaption><span>Asset/Scripts/GameState.cs</span></figcaption><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="keyword">using</span> UnityEngine;

<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameState</span> : <span class="title">MonoBehaviour</span>
{
    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> OnePullCost = <span class="number">100</span>;
    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> TenPullCost = <span class="number">1000</span>;

    <span class="keyword">public</span> <span class="built_in">int</span> crystals = <span class="number">1000</span>;
    <span class="keyword">public</span> <span class="built_in">int</span> pulls = <span class="number">0</span>;

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SpendCrystals</span>(<span class="params"><span class="built_in">int</span> numPulls</span>)</span>
    {
        crystals -= numPulls == <span class="number">1</span> ? OnePullCost : TenPullCost;
        pulls += numPulls;
    }
}</pre></td></tr></table></div>

<p>Think about it: how will the player be able to manipulate the in-game pity counter? More to come.</p>
<hr>
<h3 id="UIManager-cs"><a href="#UIManager-cs" class="headerlink" title="UIManager.cs"></a><code>UIManager.cs</code></h3><p>It is with honor I introduce to you this 549-line BEHEMOTH of a script!</p>
<div><figure class="highlight csharp" style="height: 400px; overflow: scroll; margin: 1rem 0;"><table><figcaption><span>Asset/Scripts/UIManager.cs</span></figcaption><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br></pre></td><td class="code"><pre><span class="keyword">using</span> System.Collections.Generic;
<span class="keyword">using</span> System.Collections;
<span class="keyword">using</span> UnityEngine;
<span class="keyword">using</span> UnityEngine.UI;
<span class="keyword">using</span> TMPro;
<span class="keyword">using</span> RequestClasses;
<span class="keyword">using</span> UnityEngine.EventSystems;

<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIManager</span> : <span class="title">MonoBehaviour</span>
{
    [<span class="meta">Header(<span class="string">&quot;Main Gacha&quot;</span>)</span>]
    <span class="keyword">public</span> TextMeshProUGUI crystalText;
    <span class="keyword">public</span> Button onePullButton;
    <span class="keyword">public</span> Button tenPullButton;
    <span class="keyword">public</span> Button characterDetailsButton;
    <span class="keyword">public</span> Button gachaDetailsButton;
    <span class="keyword">public</span> Button addCrystalsButton;
    <span class="keyword">public</span> Button menuButton;

    [<span class="meta">Header(<span class="string">&quot;Info Modals&quot;</span>)</span>]
    <span class="keyword">public</span> GameObject dimmedBackground;
    <span class="keyword">public</span> GameObject gachaDetailsModal;
    <span class="keyword">public</span> Button gachaDetailsModalCloseButton;
    <span class="keyword">public</span> GameObject characterDetailsModal;
    <span class="keyword">public</span> Button characterDetailsModalCloseButton;
    <span class="keyword">public</span> GameObject failedConnectionModal;
    <span class="keyword">public</span> Button failedConnectionModalCloseButton;
    <span class="keyword">public</span> GameObject tryHarderModal;
    <span class="keyword">public</span> Button tryHarderModalCloseButton;
    <span class="keyword">public</span> GameObject pullConfirmationModal;
    <span class="keyword">public</span> TextMeshProUGUI pullConfirmationText;
    <span class="keyword">public</span> TextMeshProUGUI requiredCrystalsText;
    <span class="keyword">public</span> TextMeshProUGUI currentCrystalsText;
    <span class="keyword">public</span> Button pullConfirmationContinueButton;
    <span class="keyword">public</span> Button pullConfirmationCloseButton;
    <span class="keyword">public</span> GameObject menuModal;
    <span class="keyword">public</span> Button menuModalCloseButton;
    <span class="keyword">public</span> Slider musicSlider;
    <span class="keyword">public</span> TextMeshProUGUI musicSliderValue;
    <span class="keyword">public</span> Slider sfxSlider;
    <span class="keyword">public</span> TextMeshProUGUI sfxSliderValue;
    <span class="keyword">public</span> Button exitGameButton;

    [<span class="meta">Header(<span class="string">&quot;Splash Art&quot;</span>)</span>]
    <span class="keyword">public</span> Canvas splashArtCanvas;
    <span class="keyword">public</span> TextMeshProUGUI cardNameText;
    <span class="keyword">public</span> Image splashArtBackground;
    <span class="keyword">public</span> Image backgroundTint;
    <span class="keyword">public</span> Image splashArtImage;
    <span class="keyword">public</span> Image splashArtImageMask;
    <span class="keyword">public</span> Image threeStarSplash;
    <span class="keyword">public</span> Image silhouetteImage;
    <span class="keyword">public</span> Image namecardMask;
    <span class="keyword">public</span> Image flagImage;
    <span class="keyword">public</span> GameObject stars;
    <span class="keyword">public</span> RawImage movingTriangles;
    <span class="keyword">public</span> Button skipButton;

    [<span class="meta">Header(<span class="string">&quot;Gacha Overview&quot;</span>)</span>]
    <span class="keyword">public</span> Canvas gachaOverviewCanvas;
    <span class="keyword">public</span> GridLayoutGroup gridLayoutGroup;
    <span class="keyword">public</span> GameObject avatarPrefab;
    <span class="keyword">public</span> Button nextButton;
    <span class="keyword">public</span> Button returnButton;
    <span class="keyword">public</span> Button pullAgainButton;

    <span class="keyword">private</span> GameState gameState;
    <span class="keyword">private</span> GachaManager gachaManager;
    <span class="keyword">private</span> List&lt;GameObject&gt; avatarObjects = <span class="keyword">new</span> List&lt;GameObject&gt;();
    <span class="keyword">private</span> <span class="built_in">bool</span> skipClicked = <span class="literal">false</span>;
    <span class="keyword">private</span> <span class="built_in">bool</span> isAnimating = <span class="literal">false</span>;
    <span class="keyword">private</span> <span class="built_in">float</span> oldMusicVolume;
    <span class="keyword">private</span> <span class="built_in">float</span> oldSFXVolume;
    <span class="keyword">private</span> <span class="built_in">float</span> timeSinceLastSFX = <span class="number">0f</span>;
    <span class="keyword">private</span> <span class="built_in">float</span> sfxCooldown = <span class="number">0.05f</span>;

    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span>
    {
        gameState = FindObjectOfType&lt;GameState&gt;();
        gachaManager = FindObjectOfType&lt;GachaManager&gt;();
        UpdateUI();

        onePullButton.onClick.AddListener(() =&gt; OnPullButtonClick(<span class="number">100</span>, <span class="number">1</span>));
        tenPullButton.onClick.AddListener(() =&gt; OnPullButtonClick(<span class="number">1000</span>, <span class="number">10</span>));
        skipButton.onClick.AddListener(OnSkipButtonClick);
        nextButton.onClick.AddListener(OnNextButtonClick);
        returnButton.onClick.AddListener(OnNextButtonClick);
        pullAgainButton.onClick.AddListener(OnPullAgainButtonClick);
        gachaDetailsButton.onClick.AddListener(OnGachaDetailsButtonClick);
        addCrystalsButton.onClick.AddListener(() =&gt;
        {
            GenericModalHandler(tryHarderModal, tryHarderModalCloseButton);
        });
        characterDetailsButton.onClick.AddListener(() =&gt;
        {
            GenericModalHandler(characterDetailsModal, characterDetailsModalCloseButton);
        });
        menuButton.onClick.AddListener(() =&gt;
        {
            GenericModalHandler(menuModal, menuModalCloseButton);
        });
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateUI</span>()</span>
    {
        crystalText.text = gameState.crystals.ToString();
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MusicVolume</span>()</span>
    {
        <span class="keyword">if</span> (Time.time - timeSinceLastSFX &gt;= sfxCooldown)
        {
            <span class="keyword">if</span> (musicSlider.<span class="keyword">value</span> &gt; oldMusicVolume)
            {
                AudioController.Instance.PlaySFX(<span class="string">&quot;Up&quot;</span>);
                timeSinceLastSFX = Time.time;
            }
            <span class="keyword">else</span> <span class="keyword">if</span> (musicSlider.<span class="keyword">value</span> &lt; oldMusicVolume)
            {
                AudioController.Instance.PlaySFX(<span class="string">&quot;Down&quot;</span>);
                timeSinceLastSFX = Time.time;
            }
        }
        AudioController.Instance.MusicVolume(musicSlider.<span class="keyword">value</span>);
        musicSliderValue.text = musicSlider.<span class="keyword">value</span>.ToString();
        oldMusicVolume = musicSlider.<span class="keyword">value</span>;
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SFXVolume</span>()</span>
    {
        <span class="keyword">if</span> (Time.time - timeSinceLastSFX &gt;= sfxCooldown)
        {
            <span class="keyword">if</span> (sfxSlider.<span class="keyword">value</span> &gt; oldSFXVolume)
            {
                AudioController.Instance.PlaySFX(<span class="string">&quot;Up&quot;</span>);
                timeSinceLastSFX = Time.time;
            }
            <span class="keyword">else</span> <span class="keyword">if</span> (sfxSlider.<span class="keyword">value</span> &lt; oldSFXVolume)
            {
                AudioController.Instance.PlaySFX(<span class="string">&quot;Down&quot;</span>);
                timeSinceLastSFX = Time.time;
            }
        }
        AudioController.Instance.SFXVolume(sfxSlider.<span class="keyword">value</span>);
        sfxSliderValue.text = sfxSlider.<span class="keyword">value</span>.ToString();
        oldSFXVolume = sfxSlider.<span class="keyword">value</span>;
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ExitGame</span>()</span>
    {
        Application.Quit();
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnPullButtonClick</span>(<span class="params"><span class="built_in">int</span> cost, <span class="built_in">int</span> numPulls</span>)</span>
    {
        dimmedBackground.SetActive(<span class="literal">true</span>);
        Animation pullConfirmationModalAnimation = pullConfirmationModal.GetComponent&lt;Animation&gt;();

        pullConfirmationText.text =
            <span class="string">$&quot;クリスタル&lt;color=#FF679A&gt;<span class="subst">{cost.ToString()}</span>個&lt;/color&gt;を消費して&lt;color=#FF679A&gt;<span class="subst">{numPulls.ToString()}</span>回&lt;/color&gt;\n「[小豆沢こはね] HAPPY BIRTHDAY2023ガチャ」を引\nきます。\nよろしいですか?&quot;</span>;

        requiredCrystalsText.text = cost.ToString();
        currentCrystalsText.text = gameState.crystals.ToString();
        pullConfirmationContinueButton.GetComponent&lt;ShrinkButton&gt;().enabled = <span class="literal">true</span>;
        pullConfirmationContinueButton.interactable = <span class="literal">true</span>;

        <span class="keyword">if</span> (gameState.crystals &lt; cost)
        {
            pullConfirmationContinueButton.GetComponent&lt;ShrinkButton&gt;().enabled = <span class="literal">false</span>;
            pullConfirmationContinueButton.interactable = <span class="literal">false</span>;
            currentCrystalsText.text = <span class="string">$&quot;&lt;color=#FF679A&gt;<span class="subst">{gameState.crystals.ToString()}</span>&lt;/color&gt;&quot;</span>;
        }

        pullConfirmationModal.SetActive(<span class="literal">true</span>);
        pullConfirmationModalAnimation.Play(<span class="string">&quot;ZoomIn&quot;</span>);

        pullConfirmationContinueButton.onClick.RemoveAllListeners();
        pullConfirmationCloseButton.onClick.RemoveAllListeners();

        pullConfirmationContinueButton.onClick.AddListener(() =&gt;
        {
            dimmedBackground.SetActive(<span class="literal">false</span>);
            pullConfirmationModal.SetActive(<span class="literal">false</span>);
            StartCoroutine(gachaManager.SendGachaRequest(numPulls));
        });

        pullConfirmationCloseButton.onClick.AddListener(() =&gt;
        {
            dimmedBackground.SetActive(<span class="literal">false</span>);
            pullConfirmationModalAnimation.Play(<span class="string">&quot;ZoomOut&quot;</span>);
            StartCoroutine(SetInactiveAfterDelay(pullConfirmationModal, <span class="number">0.1f</span>));
        });
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GenericModalHandler</span>(<span class="params">GameObject modal, Button closeButton</span>)</span>
    {
        dimmedBackground.SetActive(<span class="literal">true</span>);
        Animation modalAnimation = modal.GetComponent&lt;Animation&gt;();

        modal.SetActive(<span class="literal">true</span>);
        modalAnimation.Play(<span class="string">&quot;ZoomIn&quot;</span>);
        closeButton.onClick.RemoveAllListeners();
        closeButton.onClick.AddListener(() =&gt;
        {
            dimmedBackground.SetActive(<span class="literal">false</span>);
            modalAnimation.Play(<span class="string">&quot;ZoomOut&quot;</span>);
            StartCoroutine(SetInactiveAfterDelay(modal, <span class="number">0.1f</span>));
        });
    }

    <span class="function"><span class="keyword">public</span> IEnumerator <span class="title">DisplaySplashArt</span>(<span class="params">Character[] characters</span>)</span>
    {
        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; characters.Length; i++)
        {
            <span class="keyword">if</span> (skipClicked)
            {
                skipClicked = <span class="literal">false</span>;
                <span class="keyword">break</span>;
            }

            <span class="keyword">if</span> (characters[i].rarity == <span class="string">&quot;4*&quot;</span>)
            {
                StartCoroutine(DisplayFourStarCharacter(characters[i]));
            }
            <span class="keyword">else</span> <span class="keyword">if</span> (characters[i].rarity == <span class="string">&quot;3*&quot;</span>)
            {
                StartCoroutine(DisplayThreeStarCharacter(characters[i]));
            }
            <span class="keyword">else</span>
            {
                StartCoroutine(DisplayTwoStarCharacter(characters[i]));
            }

            <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForEndOfFrame</span>()</span>;
            <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitUntil</span>(<span class="params">(</span>)</span> =&gt; CheckForSkipOrClick(characters, i));

            <span class="keyword">if</span> (!skipClicked)
            {
                AudioController.Instance.PlaySFX(<span class="string">&quot;Touch&quot;</span>);
            }
        }

        DisplayGachaOverview();
    }

    <span class="function"><span class="keyword">private</span> IEnumerator <span class="title">DisplayTwoStarCharacter</span>(<span class="params">Character character</span>)</span>
    {
        ResetAnimations();
        cardNameText.text = character.cardName;
        UpdateSplashArtImage(character.splashArt, splashArtImage);
        UpdateSilhouetteImage(character.splashArt);

        Animation silhouetteImageAnimation = silhouetteImage.GetComponent&lt;Animation&gt;();
        Animation splashArtBackgroundAnimation = splashArtBackground.GetComponent&lt;Animation&gt;();
        Animation backgroundTintAnimation = backgroundTint.GetComponent&lt;Animation&gt;();
        Animation splashArtImageMaskAnimation = splashArtImageMask.GetComponent&lt;Animation&gt;();
        Animation movingTrianglesAnimation = movingTriangles.GetComponent&lt;Animation&gt;();
        Animation starsAnimation = stars.GetComponent&lt;Animation&gt;();
        Animation namecardMaskAnimation = namecardMask.GetComponent&lt;Animation&gt;();

        isAnimating = <span class="literal">true</span>;
        silhouetteImageAnimation.Play();
        splashArtBackgroundAnimation.Play();

        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params"><span class="number">1f</span></span>)</span>;

        movingTrianglesAnimation.Play();
        splashArtImageMaskAnimation.Play();
        starsAnimation.Play(<span class="string">&quot;TwoStarRarity&quot;</span>);
        AudioController.Instance.PlaySFX(<span class="string">&quot;TwoStar&quot;</span>);

        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params"><span class="number">0.5f</span></span>)</span>;

        namecardMaskAnimation.Play();

        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params"><span class="number">1f</span></span>)</span>;

        backgroundTintAnimation.Play();

        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitUntil</span>(<span class="params">
            (</span>)</span> =&gt;
                !splashArtBackgroundAnimation.isPlaying
                &amp;&amp; !backgroundTintAnimation.isPlaying
        );

        isAnimating = <span class="literal">false</span>;
    }

    <span class="function"><span class="keyword">private</span> IEnumerator <span class="title">DisplayThreeStarCharacter</span>(<span class="params">Character character</span>)</span>
    {
        ResetAnimations();
        cardNameText.text = character.cardName;
        UpdateSplashArtImage(character.splashArt, threeStarSplash);
        threeStarSplash.gameObject.SetActive(<span class="literal">true</span>);

        Animation threeStarSplashAnimation = threeStarSplash.GetComponent&lt;Animation&gt;();
        Animation starsAnimation = stars.GetComponent&lt;Animation&gt;();
        Animation namecardMaskAnimation = namecardMask.GetComponent&lt;Animation&gt;();

        isAnimating = <span class="literal">true</span>;
        threeStarSplashAnimation.Play();

        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params"><span class="number">1f</span></span>)</span>;

        starsAnimation.Play(<span class="string">&quot;ThreeStarRarity&quot;</span>);
        AudioController.Instance.PlaySFX(<span class="string">&quot;ThreeStar&quot;</span>);

        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params"><span class="number">1f</span></span>)</span>;

        namecardMaskAnimation.Play();

        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitUntil</span>(<span class="params">(</span>)</span> =&gt; !threeStarSplashAnimation.isPlaying);

        isAnimating = <span class="literal">false</span>;
        <span class="keyword">yield</span> <span class="keyword">break</span>;
    }

    <span class="function"><span class="keyword">private</span> IEnumerator <span class="title">DisplayFourStarCharacter</span>(<span class="params">Character character</span>)</span>
    {
        ResetAnimations();
        cardNameText.text = character.cardName;
        UpdateSplashArtImage(character.splashArt, threeStarSplash);
        threeStarSplash.gameObject.SetActive(<span class="literal">true</span>);

        Animation threeStarSplashAnimation = threeStarSplash.GetComponent&lt;Animation&gt;();
        Animation starsAnimation = stars.GetComponent&lt;Animation&gt;();
        Animation namecardMaskAnimation = namecardMask.GetComponent&lt;Animation&gt;();

        <span class="built_in">string</span> flag = character.flag;

        <span class="keyword">if</span> (flag != <span class="literal">null</span>)
        {
            <span class="built_in">byte</span>[] imageBytes = System.Convert.FromBase64String(flag);
            Texture2D flagTexture = <span class="keyword">new</span> Texture2D(<span class="number">2</span>, <span class="number">2</span>);
            flagTexture.LoadImage(imageBytes);

            Rect rect = <span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span>, flagTexture.width, flagTexture.height);
            Vector2 pivot = <span class="keyword">new</span> Vector2(<span class="number">0.5f</span>, <span class="number">0.5f</span>);
            Sprite flagSprite = Sprite.Create(flagTexture, rect, pivot);

            flagImage.sprite = flagSprite;
        }

        isAnimating = <span class="literal">true</span>;
        threeStarSplashAnimation.Play();

        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params"><span class="number">1f</span></span>)</span>;

        AudioController.Instance.PlaySFX(<span class="string">&quot;FourStar&quot;</span>);
        starsAnimation.Play(<span class="string">&quot;FourStarRarity&quot;</span>);
        
        flagImage.gameObject.SetActive(<span class="literal">true</span>);
        namecardMaskAnimation.Play();

        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitUntil</span>(<span class="params">(</span>)</span> =&gt; !threeStarSplashAnimation.isPlaying);

        isAnimating = <span class="literal">false</span>;
        <span class="keyword">yield</span> <span class="keyword">break</span>;
    }

    <span class="function"><span class="keyword">private</span> IEnumerator <span class="title">SetInactiveAfterDelay</span>(<span class="params">GameObject gameObject, <span class="built_in">float</span> delay</span>)</span>
    {
        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params">delay</span>)</span>;
        gameObject.gameObject.SetActive(<span class="literal">false</span>);
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateSplashArtImage</span>(<span class="params"><span class="built_in">string</span> splashArt, Image image</span>)</span>
    {
        <span class="built_in">string</span> imagePath = <span class="string">&quot;Gacha/&quot;</span> + splashArt;
        Texture2D texture = Resources.Load&lt;Texture2D&gt;(imagePath);
        image.sprite = Sprite.Create(
            texture,
            <span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span>, texture.width, texture.height),
            <span class="keyword">new</span> Vector2(<span class="number">0.5f</span>, <span class="number">0.5f</span>)
        );
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateSilhouetteImage</span>(<span class="params"><span class="built_in">string</span> splashArt</span>)</span>
    {
        <span class="built_in">string</span> imagePath = <span class="string">&quot;Gacha/&quot;</span> + splashArt;
        Texture2D texture = Resources.Load&lt;Texture2D&gt;(imagePath);

        Texture2D silhouetteTexture = <span class="keyword">new</span> Texture2D(texture.width, texture.height);
        Color[] pixels = texture.GetPixels();
        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; pixels.Length; i++)
        {
            <span class="keyword">if</span> (pixels[i].a &gt; <span class="number">0</span>)
            {
                pixels[i] = <span class="keyword">new</span> Color(<span class="number">1</span>, <span class="number">103</span> / <span class="number">255f</span>, <span class="number">154</span> / <span class="number">255f</span>, pixels[i].a);
            }
        }
        silhouetteTexture.SetPixels(pixels);
        silhouetteTexture.Apply();
        silhouetteImage.sprite = Sprite.Create(
            silhouetteTexture,
            <span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span>, texture.width, texture.height),
            <span class="keyword">new</span> Vector2(<span class="number">0.5f</span>, <span class="number">0.5f</span>)
        );
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DisplayAvatars</span>(<span class="params">Character[] characters</span>)</span>
    {
        <span class="keyword">foreach</span> (GameObject avatarObject <span class="keyword">in</span> avatarObjects)
        {
            Destroy(avatarObject);
        }

        avatarObjects.Clear();

        <span class="keyword">foreach</span> (Character character <span class="keyword">in</span> characters)
        {
            GameObject avatarObject = Instantiate(avatarPrefab, gridLayoutGroup.transform);
            avatarObjects.Add(avatarObject);

            Image avatarImage = avatarObject.GetComponent&lt;Image&gt;();
            <span class="built_in">string</span> imagePath = <span class="string">&quot;Gacha/&quot;</span> + character.avatar;
            Texture2D texture = Resources.Load&lt;Texture2D&gt;(imagePath);
            avatarImage.sprite = Sprite.Create(
                texture,
                <span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span>, texture.width, texture.height),
                <span class="keyword">new</span> Vector2(<span class="number">0.5f</span>, <span class="number">0.5f</span>)
            );
        }
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetImageOpacity</span>(<span class="params">MaskableGraphic image, <span class="built_in">float</span> targetOpacity</span>)</span>
    {
        Color imageColor = image.color;
        imageColor.a = targetOpacity;
        image.color = imageColor;
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DisplayGachaOverview</span>()</span>
    {
        <span class="keyword">if</span> (gameState.crystals &lt; <span class="number">1000</span>)
        {
            pullAgainButton.GetComponent&lt;ShrinkButton&gt;().enabled = <span class="literal">false</span>;
            pullAgainButton.interactable = <span class="literal">false</span>;
        }
        <span class="keyword">else</span>
        {
            pullAgainButton.GetComponent&lt;ShrinkButton&gt;().enabled = <span class="literal">true</span>;
            pullAgainButton.interactable = <span class="literal">true</span>;
        }
        splashArtCanvas.gameObject.SetActive(<span class="literal">false</span>);
        AudioController.Instance.FadeMusic(<span class="string">&quot;Gacha&quot;</span>);
        DisplayAvatars(gachaManager.lastGachaResponse.characters);
        AudioController.Instance.PlaySFX(<span class="string">&quot;Award&quot;</span>);
        gachaOverviewCanvas.gameObject.SetActive(<span class="literal">true</span>);
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnSkipButtonClick</span>()</span>
    {
        skipClicked = <span class="literal">true</span>;
        StopAllCoroutines();
        ResetAnimations();
        DisplayGachaOverview();
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnNextButtonClick</span>()</span>
    {
        gachaOverviewCanvas.gameObject.SetActive(<span class="literal">false</span>);
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPullAgainButtonClick</span>()</span>
    {
        StartCoroutine(gachaManager.SendGachaRequest(<span class="number">10</span>));
        StartCoroutine(SetInactiveAfterDelay(gachaOverviewCanvas.gameObject, <span class="number">0.5f</span>));
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnGachaDetailsButtonClick</span>()</span>
    {
        dimmedBackground.SetActive(<span class="literal">true</span>);
        Animation gachaDetailsModalAnimation = gachaDetailsModal.GetComponent&lt;Animation&gt;();

        ScrollRect scrollRect = gachaDetailsModal.transform
            .Find(<span class="string">&quot;GachaDetailsContent&quot;</span>)
            .GetComponent&lt;ScrollRect&gt;();

        gachaDetailsModal.SetActive(<span class="literal">true</span>);
        gachaDetailsModalAnimation.Play(<span class="string">&quot;ZoomIn&quot;</span>);
        scrollRect.verticalNormalizedPosition = <span class="number">1.05f</span>;
        gachaDetailsModalCloseButton.onClick.RemoveAllListeners();
        gachaDetailsModalCloseButton.onClick.AddListener(() =&gt;
        {
            dimmedBackground.SetActive(<span class="literal">false</span>);
            gachaDetailsModalAnimation.Play(<span class="string">&quot;ZoomOut&quot;</span>);
            StartCoroutine(SetInactiveAfterDelay(gachaDetailsModal, <span class="number">0.1f</span>));
        });
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ResetAnimations</span>()</span>
    {
        Animation silhouetteImageAnimation = silhouetteImage.GetComponent&lt;Animation&gt;();
        Animation starsAnimation = stars.GetComponent&lt;Animation&gt;();
        silhouetteImageAnimation.Stop();
        starsAnimation.Stop();

        RectTransform splashArtImageMaskRectTransform =
            splashArtImageMask.GetComponent&lt;RectTransform&gt;();
        splashArtImageMaskRectTransform.sizeDelta = <span class="keyword">new</span> Vector2(
            splashArtImageMaskRectTransform.sizeDelta.x,
            <span class="number">0.0f</span>
        );

        RectTransform namecardMaskRectTransform = namecardMask.GetComponent&lt;RectTransform&gt;();
        namecardMaskRectTransform.sizeDelta = <span class="keyword">new</span> Vector2(
            namecardMaskRectTransform.sizeDelta.x,
            <span class="number">0.0f</span>
        );

        SetImageOpacity(silhouetteImage.GetComponent&lt;Image&gt;(), <span class="number">0f</span>);
        SetImageOpacity(backgroundTint.GetComponent&lt;Image&gt;(), <span class="number">0f</span>);
        SetImageOpacity(movingTriangles.GetComponent&lt;RawImage&gt;(), <span class="number">0f</span>);

        <span class="keyword">foreach</span> (Transform child <span class="keyword">in</span> stars.transform)
        {
            Image childImage = child.GetComponent&lt;Image&gt;();
            SetImageOpacity(childImage, <span class="number">0f</span>);
        }

        flagImage.gameObject.SetActive(<span class="literal">false</span>);
    }

    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">CheckForSkipOrClick</span>(<span class="params">Character[] characters, <span class="built_in">int</span> index</span>)</span>
    {
        <span class="keyword">if</span> (skipClicked)
        {
            threeStarSplash.gameObject.SetActive(<span class="literal">false</span>);
            <span class="keyword">return</span> <span class="literal">true</span>;
        }
        <span class="keyword">if</span> (Input.GetMouseButtonDown(<span class="number">0</span>))
        {
            <span class="keyword">if</span> (
                !isAnimating
                &amp;&amp; EventSystem.current.currentSelectedGameObject != skipButton.gameObject
            )
            {
                <span class="keyword">if</span> (characters[index].rarity == <span class="string">&quot;3*&quot;</span> || characters[index].rarity == <span class="string">&quot;4*&quot;</span>)
                {
                    threeStarSplash.gameObject.SetActive(<span class="literal">false</span>);
                }

                <span class="keyword">return</span> <span class="literal">true</span>;
            }
        }
        <span class="keyword">return</span> <span class="literal">false</span>;
    }
}</pre></td></tr></table></div>

<p>I know this looks intensely overwhelming, but it’s just because all of these different, uncorrelated methods are all thrown into single file because they all have to do with UI; it’s not actually that bad if you chunk it up to make it more digestible. I’ll attempt to briefly explain each of these methods with a giant TL;DR table (which is just… sheer ridiculousness 🤣):</p>
<table class="ui-manager-table">
    <thead>
        <tr>
            <th>Method Name</th>
            <th>Functionality</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
                <code>public void Start()</code>
            </td>
            <td>We can totally ignore <a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/MonoBehaviour.Start.html">
                    <code>MonoBehaviour.Start()</code>
                </a> because it just consists of a bunch of <code>AddListener()</code> calls to the various buttons in the game. I could have mitigated this by using the Unity GUI’s <code>OnClick()</code> functionality for buttons to directly call the appropriate methods, but out of personal preference I chose to do it this way. </td>
        </tr>
        <tr>
            <td>
                <code>public void UpdateUI()</code>
            </td>
            <td>Genuinely just a one-liner. The only reason why it’s its own public method is because <code>GachaManager</code> calls it when it finishes up a successful request. </td>
        </tr>
        <tr>
            <td>
                <code>public void MusicVolume()</code>
            </td>
            <td>Used in the volume sliders in <code>menuModal</code>. Utilizes the <code>AudioController</code> (which we’ll go over later) to adjust sounds: <img src="/static/sekaictf-2023/volume-sliders.png" alt="Volume Sliders"> Also plays a little sound effect which changes pitch depending on the direction the slider is moving. Of course, since we don’t want the sound effect to be spammed per tick of the slider, I added a cooldown. </td>
        </tr>
        <tr>
            <td>
                <code>public void SFXVolume()</code>
            </td>
            <td>Same thing as <code>MusicVolume()</code> except for SFX. </td>
        </tr>
        <tr>
            <td>
                <code>public void ExitGame()</code>
            </td>
            <td>Also a one-liner: <code>Application.Quit()</code>. </td>
        </tr>
        <tr>
            <td>
                <code>public void OnPullButtonClick()</code>
            </td>
            <td>
                <strong>Parameters</strong>: <code>int cost, int numPulls</code>
                <br>Opens the <code>pullConfirmationModal</code> and changes the various TextMeshPro objects inside to be accurate (changes the color of <code>currentCrystalsText</code> to red and disables <code>pullConfirmationContinueButton</code> if the user doesn’t have enough crystals): <img src="/static/sekaictf-2023/confirmation-modal.png" alt="Confirmation Modal">
            </td>
        </tr>
        <tr>
            <td>
                <code>public void GenericModalHandler()</code>
            </td>
            <td>
                <strong>Parameters</strong>: <code>GameObject modal, Button closeButton</code>
                <br>Plays the default zoom-in/zoom-out animations, sound effects, and enables darkened background whenever a modal is opened via button: <img src="/static/sekaictf-2023/modal-handler.gif" alt="Modal Handler">
            </td>
        </tr>
        <tr>
            <td>
                <code>public IEnumerator DisplaySplashArt()</code>
            </td>
            <td>
                <strong>Parameters</strong>: <code>Character[] characters</code>
                <br>Whenever you pull for characters in Project Sekai, a “carousel” of “splash art” representing each character appears one-by-one on your screen until you’ve cycled through everything you’ve pulled. This method handles the entire process by cycling through the <code>Character[]</code> array and calling the following <code>Display____StarCharacter()</code> coroutines (will be referred to as “splash art coroutines” from here for brevity). It pauses the iteration through the loop (via <code>WaitUntil(() =&gt; CheckForSkipOrClick(characters, i))</code>) until the user clicks after the aforementioned coroutine is completed.
            </td>
        </tr>
        <tr>
            <td>
                <code>private IEnumerator DisplayTwoStarCharacter()</code>
            </td>
            <td>
                <strong>Parameters</strong>: <code>Character character</code>
                <br>Handles the animations and sound effects for a two-star splash art. Since I chose to animate using the seriously outdated legacy Animation component (I was too lazy to learn the new Animator), I had to trigger the animations through code. It’s seriously ugly, but for such a small use case like this I didn’t find it necessary: <img src="/static/sekaictf-2023/two-star-animation.gif" alt="Two Star Animation"> The script replaces every pixel in the initial splash art with a static color representing the character (Kohane’s is <code>#FF679A</code>) to create a silhouette, and uses a moving mask to achieve a “wiping” animation on top of the silhouette. The silhouette then moves diagonally to create a shadow. The background triangle movement was achieved using the <code>BackgroundScroller.cs</code> file, which will be overviewed later.
            </td>
        </tr>
        <tr>
            <td>
                <code>private IEnumerator DisplayThreeStarCharacter()</code>
            </td>
            <td>
                <strong>Parameters</strong>: <code>Character character</code>
                <br>Handles three-star splash art. Since splash art for this rarity takes up the entire screen instead of using a small silhouette, I had to give it different treatment (and therefore different animations): <img src="/static/sekaictf-2023/three-star-animation.gif" alt="Three Star Animation">
            </td>
        </tr>
        <tr>
            <td>
                <code>private IEnumerator DisplayFourStarCharacter()</code>
            </td>
            <td>
                <strong>Parameters</strong>: <code>Character character</code>
                <br>Will be revealed when solving the challenge!
            </td>
        </tr>
        <tr>
            <td>
                <code>private IEnumerator SetInactiveAfterDelay()</code>
            </td>
            <td>
                <strong>Parameters</strong>: <code>GameObject gameObject, float delay</code>
                <br>Just a simple utility method which is typically called when closing a modal. Since we want the closing animation to play (rather than disabling the modal immediately), we wait a little bit before setting it to inactive.
            </td>
        </tr>
        <tr>
            <td>
                <code>private void UpdateSplashArtImage()</code>
            </td>
            <td>
                <strong>Parameters</strong>: <code>string splashArt, Image image</code>
                <br>Changes the image after each iteration through the splash art carousel, called at the beginning of every splash art coroutine.
            </td>
        </tr>
        <tr>
            <td>
                <code>private void UpdateSilhouetteImage()</code>
            </td>
            <td>
                <strong>Parameters</strong>: <code>string splashArt</code>
                <br>Replaces each pixel within a splash art to create a silhouette of solid color. Called in <code>DisplayTwoStarCharacter()</code>.
            </td>
        </tr>
        <tr>
            <td>
                <code>private void DisplayAvatars()</code>
            </td>
            <td>
                <strong>Parameters</strong>: <code>Character[] characters</code>
                <br>Handles the instantiation/destruction of <code>avatarImages</code> within the Grid Layout Group component of <code>gachaOverviewCanvas</code>: <img src="/static/sekaictf-2023/gacha-overview.gif" alt="Gacha Overview">
            </td>
        </tr>
        <tr>
            <td>
                <code>private void SetImageOpacity()</code>
            </td>
            <td>
                <strong>Parameters</strong>: <code>MaskableGraphic image, float targetOpacity</code>
                <br>Utility method exclusively for <code>ResetAnimations()</code>. Used to set transparency to 0 when resetting animations.
            </td>
        </tr>
        <tr>
            <td>
                <code>private void DisplayGachaOverview()</code>
            </td>
            <td>Disables and enables all the appropriate layers and plays the correct sound effects during the transition to the gacha overview page (the grid layout screen with avatars of all the characters you’ve pulled). Fades the looping music in the background into a different song.</td>
        </tr>
        <tr>
            <td>
                <code>private void OnSkipButtonClick()</code>
            </td>
            <td>Skips the splash art carousel (via <code>StopAllCoroutines()</code>) and goes straight to the gacha overview screen. </td>
        </tr>
        <tr>
            <td>
                <code>private void OnNextButtonClick()</code>
            </td>
            <td>A one-liner which disables the gacha overview once the user is finished observing it.</td>
        </tr>
        <tr>
            <td>
                <code>private void OnPullAgainButtonClick()</code>
            </td>
            <td>Starts the entire backend request -&gt; splash art carousel event chain once again, as long as the user has enough crystals. Is disabled/greyed out if otherwise.</td>
        </tr>
        <tr>
            <td>
                <code>private void OnGachaDetailsButtonClick()</code>
            </td>
            <td>Dedicated listener for the <code>gachaDetailsModal</code> instead of using <code>GenericModalHandler()</code>. For some reason, the Scroll Rect component’s area was bugging out whenever it interacted with my zoom-in/zoom-out animations, with the scrollable area seemingly moving on its own whenever the modal is opened/closed. This method resets the <code>verticalNormalizedPosition</code> of the Scroll Rect each time to prevent this. </td>
        </tr>
        <tr>
            <td>
                <code>private void ResetAnimations()</code>
            </td>
            <td>Resets every animation at the start of each iteration (e.g. moving the mask back to its place, changing opacities/colors back to normal).</td>
        </tr>
        <tr>
            <td>
                <code>private bool CheckForSkipOrClick()</code>
            </td>
            <td>
                <strong>Parameters</strong>: <code>Character[] characters, int index</code>
                <br>An isolated part of the <code>DisplaySplashArt()</code> coroutine, which checks to see if the user has clicked on the screen to iterate through the carousel.
            </td>
        </tr>
    </tbody>
</table>

<hr>
<h3 id="AudioController-cs"><a href="#AudioController-cs" class="headerlink" title="AudioController.cs"></a><code>AudioController.cs</code></h3><p>An extremely undervalued aspect of video games which give them that beautiful polish is sound design. Of course, I’m not the one creating the sound effects themselves; that’s an entirely different universe. For sound effects in this challenge, I scoured through some online asset rips of the official game: <a target="_blank" rel="noopener" href="https://sekai.best/asset_viewer/sound/system/">sekai.best</a>‘s asset viewer, and the <a target="_blank" rel="noopener" href="https://pjsek.ai/assets">pjsek.ai</a> database:</p>
<p><img src="/static/sekaictf-2023/sekai-best-asset-viewer.png" alt="Sekai.best Asset Viewer"></p>
<p><img src="/static/sekaictf-2023/pjsekai-database.png" alt="PJSekai Database"></p>
<p>Any SFX assets I weren’t able to find I ended up taking from the game itself——I ended up taking a screen recording of me pulling the gacha and cutting out the various sound effects I heard (with the music volume at 0%). From this, alongside recordings of people fiddling with the gacha system on YouTube, I was able to deduce which sound effects needed to be triggered when. I finished off the recordings with a bit of post-processing in Audacity:</p>
<p><img src="/static/sekaictf-2023/audacity.png" alt="Audacity"></p>
<p>The <code>AudioController.cs</code> itself first needs a class <code>Sound</code>, which defines an <code>AudioClip</code> with a name:</p>
<div><figure class="highlight csharp" style=""><table><figcaption><span>Assets/Scripts/Sound.cs</span></figcaption><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="keyword">using</span> UnityEngine;

[<span class="meta">System.Serializable</span>]
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sound</span>
{
    <span class="keyword">public</span> <span class="built_in">string</span> name;
    <span class="keyword">public</span> AudioClip clip;
}</pre></td></tr></table></div>

<p>We can now define the audio controller to take an array of <code>Sound[]</code>s and two floats for their respective volumes. The audio controller will have a plethora of useful methods to call throughout our other scripts:</p>
<div><figure class="highlight csharp" style="height: 400px; overflow: scroll; margin: 1rem 0;"><table><figcaption><span>Assets/Scripts/AudioController.cs</span></figcaption><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="keyword">using</span> System.Collections;
<span class="keyword">using</span> System.Collections.Generic;
<span class="keyword">using</span> UnityEngine;
<span class="keyword">using</span> System;

<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AudioController</span> : <span class="title">MonoBehaviour</span>
{
    <span class="keyword">public</span> <span class="keyword">static</span> AudioController Instance;
    <span class="keyword">private</span> UIManager uiManager;
    <span class="keyword">public</span> Sound[] musicSounds,
        sfxSounds;
    <span class="keyword">public</span> AudioSource musicSource,
        sfxSource;
    <span class="keyword">public</span> <span class="built_in">float</span> fadeTime = <span class="number">1.0f</span>;

    <span class="keyword">private</span> <span class="built_in">bool</span> isFading = <span class="literal">false</span>;

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span>
    {
        <span class="keyword">if</span> (Instance == <span class="literal">null</span>)
        {
            Instance = <span class="keyword">this</span>;
            DontDestroyOnLoad(gameObject);
        }
        <span class="keyword">else</span>
        {
            Debug.LogWarning(<span class="string">$&quot;Duplicate <span class="subst">{gameObject.name}</span> found, destroying...&quot;</span>);
            Destroy(gameObject);
        }
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span>
    {
        PlayMusic(<span class="string">&quot;Gacha&quot;</span>);
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PlayMusic</span>(<span class="params"><span class="built_in">string</span> name</span>)</span>
    {
        Sound sound = System.Array.Find(musicSounds, sound =&gt; sound.name == name);
        <span class="keyword">if</span> (sound == <span class="literal">null</span>)
        {
            Debug.LogWarning(<span class="string">$&quot;Sound <span class="subst">{name}</span> not found!&quot;</span>);
            <span class="keyword">return</span>;
        }

        musicSource.clip = sound.clip;
        musicSource.Play();
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FadeMusic</span>(<span class="params"><span class="built_in">string</span> name</span>)</span>
    {
        <span class="keyword">if</span> (isFading)
        {
            StopAllCoroutines();
            AudioSource[] audioSources = GetComponents&lt;AudioSource&gt;();
            <span class="keyword">foreach</span> (AudioSource audioSource <span class="keyword">in</span> audioSources)
            {
                <span class="keyword">if</span> (audioSource != musicSource &amp;&amp; audioSource != sfxSource)
                {
                    audioSource.Stop();
                    Destroy(audioSource);
                }
            }
            isFading = <span class="literal">false</span>;
        }

        StartCoroutine(Fade(name));
    }

    <span class="function">IEnumerator <span class="title">Fade</span>(<span class="params"><span class="built_in">string</span> name</span>)</span>
    {
        isFading = <span class="literal">true</span>;

        Sound sound = System.Array.Find(musicSounds, sound =&gt; sound.name == name);
        <span class="keyword">if</span> (sound == <span class="literal">null</span>)
        {
            Debug.LogWarning(<span class="string">$&quot;Sound <span class="subst">{name}</span> not found!&quot;</span>);
            <span class="keyword">yield</span> <span class="keyword">break</span>;
        }

        AudioSource newMusicSource = gameObject.AddComponent&lt;AudioSource&gt;();
        newMusicSource.clip = sound.clip;
        newMusicSource.loop = <span class="literal">true</span>;
        newMusicSource.Play();
        newMusicSource.volume = <span class="number">0.0f</span>;

        <span class="built_in">float</span> startVolume1 = musicSource.volume;
        <span class="built_in">float</span> startVolume2 = newMusicSource.volume;
        <span class="built_in">float</span> currentTime = <span class="number">0.0f</span>;

        uiManager = FindObjectOfType&lt;UIManager&gt;();
        <span class="built_in">float</span> endVolume = uiManager.musicSlider.<span class="keyword">value</span> / <span class="number">100.0f</span>;

        <span class="keyword">while</span> (currentTime &lt; fadeTime)
        {
            currentTime += Time.deltaTime;
            musicSource.volume = Mathf.Lerp(startVolume1, <span class="number">0.0f</span>, currentTime / fadeTime);
            newMusicSource.volume = Mathf.Lerp(startVolume2, endVolume, currentTime / fadeTime);
            <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;
        }

        musicSource.volume = <span class="number">0.0f</span>;
        newMusicSource.volume = endVolume;

        musicSource.Stop();
        Destroy(musicSource);
        musicSource = newMusicSource;

        isFading = <span class="literal">false</span>;
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PlaySFX</span>(<span class="params"><span class="built_in">string</span> name</span>)</span>
    {
        Sound sound = System.Array.Find(sfxSounds, sound =&gt; sound.name == name);
        <span class="keyword">if</span> (sound == <span class="literal">null</span>)
        {
            Debug.LogWarning(<span class="string">$&quot;Sound <span class="subst">{name}</span> not found!&quot;</span>);
            <span class="keyword">return</span>;
        }

        sfxSource.PlayOneShot(sound.clip);
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MusicVolume</span>(<span class="params"><span class="built_in">float</span> volume</span>)</span>
    {
        musicSource.volume = volume / <span class="number">100.0f</span>;
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SFXVolume</span>(<span class="params"><span class="built_in">float</span> volume</span>)</span>
    {
        sfxSource.volume = volume / <span class="number">100.0f</span>;
    }
}</pre></td></tr></table></div>

<p>With this, we can now freely drag audio clips into the audio controller, rename them, and call them on a whim from any of our other scripts, like our <code>UIManager.cs</code>:</p>
<p><img src="/static/sekaictf-2023/audio-inspector.png" alt="Audio Inspector"></p>
<div><figure class="highlight csharp" style=""><table><figcaption><span>Audio Controller Usage (UIManager.cs)</span></figcaption><tr><td class="gutter"><pre><span class="line">433</span><br><span class="line">434</span><br><div style="margin:1.2em 0"><span class="line"> </span></div><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br></pre></td><td class="code"><pre>    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DisplayGachaOverview</span>()</span>
    {
<div class="skip-highlight">435-444</div>
        splashArtCanvas.gameObject.SetActive(<span class="literal">false</span>);
<div class="diff-highlight-add">        AudioController.Instance.FadeMusic(<span class="string">&quot;Gacha&quot;</span>);</div>
        DisplayAvatars(gachaManager.lastGachaResponse.characters);
<div class="diff-highlight-add">        AudioController.Instance.PlaySFX(<span class="string">&quot;Award&quot;</span>);</div>
        gachaOverviewCanvas.gameObject.SetActive(<span class="literal">true</span>);
    }</pre></td></tr></table></div>

<hr>
<h3 id="BackgroundScroller-cs"><a href="#BackgroundScroller-cs" class="headerlink" title="BackgroundScroller.cs"></a><code>BackgroundScroller.cs</code></h3><p>This script is responsible for the diagonal movement in the background of the splash art carousel and the gacha overview screen. It’s a simple script which moves the background <code>RawImage</code>‘s UV Rect diagonally:</p>
<div><figure class="highlight csharp" style=""><table><figcaption><span>Assets/Scripts/BackgroundScroller.cs</span></figcaption><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="keyword">using</span> UnityEngine;
<span class="keyword">using</span> UnityEngine.UI;

<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BackgroundScroller</span> : <span class="title">MonoBehaviour</span>
{
    <span class="keyword">public</span> RawImage image;
    <span class="keyword">public</span> <span class="built_in">float</span> x,
        y;

    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span>
    {
        image.uvRect = <span class="keyword">new</span> Rect(
            image.uvRect.position + <span class="keyword">new</span> Vector2(x, y) * Time.deltaTime,
            image.uvRect.size
        );
    }
}</pre></td></tr></table></div>

<p><img src="/static/sekaictf-2023/background-scroll.gif" alt="Background Scroll"></p>
<p>This only works if the image asset itself has a Wrap Mode of “Repeat” (instead of “Clamp”).</p>
<hr>
<h3 id="ShrinkButton-cs"><a href="#ShrinkButton-cs" class="headerlink" title="ShrinkButton.cs"></a><code>ShrinkButton.cs</code></h3><p>The <a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Prefabs.html">Prefab</a> system was utilized to create a reusable component for every button, containing interactive transition colors and a script which handled the button’s shrinking&#x2F;expanding animations on-click:</p>
<p><img src="/static/sekaictf-2023/unity-prefab.png" alt="Unity Prefab"></p>
<div><figure class="highlight csharp" style="height: 400px; overflow: scroll; margin: 1rem 0;"><table><figcaption><span>Assets/Scripts/ShrinkButton.cs</span></figcaption><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="keyword">using</span> System.Collections;
<span class="keyword">using</span> UnityEngine;
<span class="keyword">using</span> UnityEngine.UI;
<span class="keyword">using</span> UnityEngine.EventSystems;

<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ShrinkButton</span> : <span class="title">MonoBehaviour</span>, <span class="title">IPointerDownHandler</span>, <span class="title">IPointerUpHandler</span>
{
    <span class="keyword">public</span> Button button;
    <span class="keyword">public</span> <span class="built_in">float</span> shrinkFactor = <span class="number">0.95f</span>;
    <span class="keyword">public</span> <span class="built_in">float</span> shrinkTime = <span class="number">0.07f</span>;
    <span class="keyword">public</span> <span class="built_in">string</span> clickSoundEffect;

    <span class="keyword">private</span> Vector3 originalScale;

    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span>
    {
        originalScale = transform.localScale;
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnPointerDown</span>(<span class="params">PointerEventData eventData</span>)</span>
    {
        StopAllCoroutines();
        StartCoroutine(Shrink());
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnPointerUp</span>(<span class="params">PointerEventData eventData</span>)</span>
    {
        StopAllCoroutines();
        AudioController.Instance.PlaySFX(clickSoundEffect);
        StartCoroutine(Grow());
    }

    <span class="function">IEnumerator <span class="title">Shrink</span>()</span>
    {
        Vector3 targetScale = originalScale * shrinkFactor;
        <span class="built_in">float</span> currentTime = <span class="number">0.0f</span>;

        <span class="keyword">do</span>
        {
            transform.localScale = Vector3.Lerp(
                originalScale,
                targetScale,
                currentTime / shrinkTime
            );
            currentTime += Time.deltaTime;
            <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;
        } <span class="keyword">while</span> (currentTime &lt;= shrinkTime);

        transform.localScale = targetScale;
    }

    <span class="function">IEnumerator <span class="title">Grow</span>()</span>
    {
        Vector3 targetScale = originalScale;
        <span class="built_in">float</span> currentTime = <span class="number">0.0f</span>;

        <span class="keyword">do</span>
        {
            transform.localScale = Vector3.Lerp(
                transform.localScale,
                targetScale,
                currentTime / shrinkTime
            );
            currentTime += Time.deltaTime;
            <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;
        } <span class="keyword">while</span> (currentTime &lt;= shrinkTime);

        transform.localScale = targetScale;
    }
}</pre></td></tr></table></div>

<p>This is the resulting behavior:</p>
<p><img src="/static/sekaictf-2023/shrink-button.gif" alt="Shrink Button"></p>
<hr>
<h3 id="CameraScaler-cs"><a href="#CameraScaler-cs" class="headerlink" title="CameraScaler.cs"></a><code>CameraScaler.cs</code></h3><p>These two scripts were adopted from the <a target="_blank" rel="noopener" href="https://github.com/wmjoers/CameraScaler"><code>wmjoers/CameraScaler</code></a> repository, which provided fixes to bad aspect ratios on standalone 2D unity bundles. Think of it as converting an image in CSS from <code>object-fit: cover</code> to <code>object-fit: contain</code>, so that the game camera itself preserves its aspect ratio even when the game window is altered:</p>
<p><img src="/static/sekaictf-2023/fullscreen-fix.gif" alt="Fullscreen Fix"></p>
<div><figure class="highlight csharp" style="height: 400px; overflow: scroll; margin: 1rem 0;"><table><figcaption><span>Assets/Scripts/CameraScaler.cs</span></figcaption><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="keyword">using</span> UnityEngine;

[<span class="meta">RequireComponent(typeof(Camera))</span>]
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CameraScaler</span> : <span class="title">MonoBehaviour</span>
{
    [<span class="meta">SerializeField</span>] <span class="keyword">protected</span> <span class="built_in">int</span> targetWidth = <span class="number">1920</span>;
    [<span class="meta">SerializeField</span>] <span class="keyword">protected</span> <span class="built_in">int</span> targetHeight = <span class="number">1080</span>;

    [<span class="meta">SerializeField</span>] <span class="keyword">protected</span> <span class="built_in">int</span> dynamicMaxWidth = <span class="number">2560</span>;
    [<span class="meta">SerializeField</span>] <span class="keyword">protected</span> <span class="built_in">int</span> dynamicMaxHeight = <span class="number">1440</span>;

    [<span class="meta">SerializeField</span>] <span class="keyword">protected</span> <span class="built_in">bool</span> useDynamicWidth = <span class="literal">false</span>;
    [<span class="meta">SerializeField</span>] <span class="keyword">protected</span> <span class="built_in">bool</span> useDynamicHeight = <span class="literal">false</span>;

    <span class="keyword">private</span> Camera cam;
    <span class="keyword">private</span> <span class="built_in">int</span> lastWidth = <span class="number">0</span>;
    <span class="keyword">private</span> <span class="built_in">int</span> lastHeight = <span class="number">0</span>;

    <span class="keyword">private</span> <span class="built_in">float</span> orthoSize;

    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span>
    {
        cam = GetComponent&lt;Camera&gt;();
        orthoSize = cam.orthographicSize;
    }

    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Update</span>()</span>
    {
        <span class="keyword">if</span> (Screen.width != lastWidth || Screen.height != lastHeight)
        {
            UpdateCamSize();
            lastWidth = Screen.width;
            lastHeight = Screen.height;
        }
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateCamSize</span>()</span>
    {
        <span class="built_in">float</span> targetAspect;
        <span class="built_in">float</span> screenAspect = (<span class="built_in">float</span>)Screen.width / (<span class="built_in">float</span>)Screen.height;
        <span class="built_in">float</span> ortoScale = <span class="number">1f</span>;

        <span class="keyword">if</span> (useDynamicWidth)
        {
            <span class="built_in">float</span> minTargetAspect = (<span class="built_in">float</span>)targetWidth / (<span class="built_in">float</span>)targetHeight;
            <span class="built_in">float</span> maxTargetAspect = (<span class="built_in">float</span>)dynamicMaxWidth / (<span class="built_in">float</span>)targetHeight;
            targetAspect = Mathf.Clamp(screenAspect, minTargetAspect, maxTargetAspect);
        }
        <span class="keyword">else</span>
        {
            targetAspect = (<span class="built_in">float</span>)targetWidth / (<span class="built_in">float</span>)targetHeight;
        }

        <span class="built_in">float</span> scaleValue = screenAspect / targetAspect;

        Rect rect = <span class="keyword">new</span>();
        <span class="keyword">if</span> (scaleValue &lt; <span class="number">1f</span>)
        {
            <span class="keyword">if</span> (useDynamicHeight)
            {
                <span class="built_in">float</span> minTargetAspect = (<span class="built_in">float</span>)targetWidth / (<span class="built_in">float</span>)dynamicMaxHeight;
                <span class="keyword">if</span> (screenAspect &lt; minTargetAspect)
                {
                    scaleValue = screenAspect / minTargetAspect;
                    ortoScale = minTargetAspect / targetAspect;
                }
                <span class="keyword">else</span>
                {
                    ortoScale = scaleValue;
                    scaleValue = <span class="number">1f</span>;
                }
            }

            rect.width = <span class="number">1</span>;
            rect.height = scaleValue;
            rect.x = <span class="number">0</span>;
            rect.y = (<span class="number">1</span> - scaleValue) / <span class="number">2</span>;
        }
        <span class="keyword">else</span>
        {
            scaleValue = <span class="number">1</span> / scaleValue;
            rect.width = scaleValue;
            rect.height = <span class="number">1</span>;
            rect.x = (<span class="number">1</span> - scaleValue) / <span class="number">2</span>;
            rect.y = <span class="number">0</span>;
        }

        cam.orthographicSize = orthoSize / ortoScale;
        cam.rect = rect;
    }
}</pre></td></tr></table></div>

<div><figure class="highlight csharp" style="height: 400px; overflow: scroll; margin: 1rem 0;"><table><figcaption><span>Assets/Scripts/FullscreenHandler.cs</span></figcaption><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="keyword">using</span> System.Collections;
<span class="keyword">using</span> System.Collections.Generic;
<span class="keyword">using</span> UnityEngine;

<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FullscreenHandler</span> : <span class="title">MonoBehaviour</span>
{
    <span class="keyword">private</span> <span class="built_in">bool</span> lastFullscreen;
    <span class="keyword">private</span> <span class="built_in">int</span> lastResolutionWidth = <span class="number">0</span>;
    <span class="keyword">private</span> <span class="built_in">int</span> lastResolutionHeight = <span class="number">0</span>;

    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span>
    {
        lastResolutionWidth = Screen.currentResolution.width;
        lastResolutionHeight = Screen.currentResolution.height;
        lastFullscreen = Screen.fullScreen;
    }

    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span>
    {
        <span class="keyword">if</span> (Screen.fullScreen != lastFullscreen)
        {
            <span class="keyword">if</span> (Screen.fullScreen)
            {
                Screen.SetResolution(lastResolutionWidth, lastResolutionHeight, <span class="literal">true</span>);
            }
            lastFullscreen = Screen.fullScreen;
        }

        <span class="keyword">if</span> (!Screen.fullScreen &amp;&amp; (Screen.currentResolution.width != lastResolutionWidth || Screen.currentResolution.height != lastResolutionHeight))
        {
            lastResolutionWidth = Screen.currentResolution.width;
            lastResolutionHeight = Screen.currentResolution.height;
        }
    }
}</pre></td></tr></table></div>

<hr>
<p>Since we have a lot of context now on how the game is made and the various scripts that we need to exploit&#x2F;manipulate, we can now trivially reverse-engineer the game and hack in the 4* character. Let’s get started!</p>
<h2 id="Writeup"><a href="#Writeup" class="headerlink" title="Writeup"></a>Writeup</h2><div class="challenge">
    <div class="challenge-title"><h3 id="Azusawa's-Gacha-World" class="chal-title"><a href="#Azusawa's-Gacha-World" class="headerlink" title="Azusawa's Gacha World"></a>Azusawa's Gacha World</h3></div>
    <div style="display:flex;" class="no-highlight">
        <div class="challenge-info">
            <div class="center-align">
                
                <i class="fa-solid fa-square-pen fa-fw"></i> <b>author</b>: <img style="display: inline-block; border-radius: 50%; width: 20px; margin-bottom: -6px;" src="https://avatars.githubusercontent.com/u/71956291"> <a target="_blank" rel="noopener" href="https://github.com/jktrn">enscribe</a><br>
                <i class="fa-solid fa-tag fa-fw"></i> <b>genre</b>: reverse<br>
                <i class="fa-solid fa-circle-plus fa-fw"></i> <b>points</b>: 100<br>
                
                <i class="fa-solid fa-file fa-fw"></i> <b>files</b>: <a target="_blank" rel="noopener" href="https://storage.googleapis.com/sekaictf-2023/azusawa/dist.zip">dist.zip</a><br>
            </div>
        </div>
        <div class="challenge-description">
            <div class="center-align" >
                <a target="_blank" rel="noopener" href="https://azusawa.world/#/2023/03/02">https://azusawa.world/#/2023/03/02</a><br><br>
❖ Note:
The website only contains the challenge description, and is not needed to solve the challenge.
                
            </div>
        </div>
    </div>
    </div>

<p>We’re initially provided with a <code>dist/</code> folder with the following structure:</p>
<p><img src="/static/sekaictf-2023/initial-folder-structure.svg" alt="Initial Folder Structure"></p>
<p>Opening up the executable in Windows will reveal a video game titled “Azusawa’s Gacha World”, built with the Unity engine:</p>
<p><img src="/static/sekaictf-2023/initial-launch.png" alt="Initial Launch"></p>
<p>It’s… an entirely Japanese gacha game! We can totally pull on the gacha with our 100 crystals to start off with, but we quickly realize that this entire system is rigged from the second button on the bottom left (which reads ガチャ詳細 -&gt; “Gacha Details”):</p>
<p><img src="/static/sekaictf-2023/gacha-details.png" alt="Gacha Details"></p>
<p>We can see that we were provided a list of percentages, which indicate the chance that each rarity of character will be dropped. The top rarity, the bow icon, indicates a “special” rarity of character that has a 0% chance of dropping from the pool.</p>
<p>Check out that emphasized text in pink, however. Although players are meant to OCR the text for translation (or just know Japanese), I’ll skip the notion and just  translate it:</p>
<blockquote>
<p>注意: このキャラクターは、このピックアップで行う<strong>100万回目</strong>の引き出しで保証されます。<br>NOTE: This character is guaranteed on the <strong>1,000,000th</strong> withdrawal made in this pickup.</p>
</blockquote>
<p>Of course, this means that we would need to pull a million times to get our desired character. That’s no fun——so how are we going to manipulate this game to make it think that we’ve already pulled a million times?</p>
<p>Let’s use <a target="_blank" rel="noopener" href="https://github.com/dnSpy/dnSpy">dnSpy v6.1.8</a> to our advantage here to reverse engineer the game. Since all Unity-compiled C# code goes into an <code>Assembly-CSharp.dll</code> within the <code>dist/Asusawa&#39;s Gacha World_Data/Managed</code> directory, we should be analyzing this file first and foremost. Opening dnSpy and dragging the DLL into the program will reveal the following structure:</p>
<p><img src="/static/sekaictf-2023/initial-dnspy.png" alt="Initial dnSpy"></p>
<p>Sifting through the code, the most relevant script out of all seems to be a <code>GachaManager.cs</code>, which creates <code>POST</code> requests to a backend server of some kind. We find a suspicious string near the top of the <code>CreateGachaWebRequest()</code> method:</p>
<p><img src="/static/sekaictf-2023/suspicious-string.png" alt="Suspicious String"></p>
<p>Deobfuscating this string with a simple base64 decoder reveals the following IP address, which is the endpoint that the game is sending requests to:</p>
<p><img src="/static/sekaictf-2023/decode-base64.png" alt="Decode Base64"></p>
<p>Let’s figure out the structure that the game is sending to the server. Let’s take a closer look at the <code>CreateGachaWebRequest()</code> method:</p>
<div><figure class="highlight csharp" style=""><table><figcaption><span>[Assembly-CSharp.dll] CreateGachaWebRequest Method</span></figcaption><tr><td class="gutter"><pre><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="comment">// Token: 0x06000016 RID: 22 RVA: 0x0000259C File Offset: 0x0000079C</span>
<span class="function"><span class="keyword">private</span> UnityWebRequest <span class="title">CreateGachaWebRequest</span>(<span class="params"><span class="built_in">string</span> json</span>)</span>
{
    <span class="built_in">byte</span>[] bytes = Encoding.UTF8.GetBytes(json);
    <span class="built_in">string</span> s = <span class="string">&quot;aHR0cDovLzE3Mi44Ni42NC44OTozMDAwL2dhY2hh&quot;</span>;
    UnityWebRequest unityWebRequest = <span class="keyword">new</span> UnityWebRequest(Encoding.UTF8.GetString(Convert.FromBase64String(s)), <span class="string">&quot;POST&quot;</span>);
    unityWebRequest.uploadHandler = <span class="keyword">new</span> UploadHandlerRaw(bytes);
    unityWebRequest.downloadHandler = <span class="keyword">new</span> DownloadHandlerBuffer();
<div class="diff-highlight-add">    unityWebRequest.SetRequestHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</div>
<div class="diff-highlight-add">    unityWebRequest.SetRequestHeader(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;SekaiCTF&quot;</span>);</div>
    <span class="keyword">return</span> unityWebRequest;
}</pre></td></tr></table></div>

<p>We can see that <code>SetRequestHeader()</code> is being called to add some custom headers to the web request: <code>User-Agent: SekaiCTF</code> and <code>Content-Type: application/json</code>. The contents of the JSON payload itself can be reversed from the <code>SendGachaRequest()</code> class:</p>
<div><figure class="highlight csharp" style="height: 400px; overflow: scroll; margin: 1rem 0;"><table><figcaption><span>[Assembly-CSharp.dll] SendGachaRequest Method</span></figcaption><tr><td class="gutter"><pre><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="comment">// Token: 0x06000015 RID: 21 RVA: 0x00002585 File Offset: 0x00000785</span>
<span class="function"><span class="keyword">public</span> IEnumerator <span class="title">SendGachaRequest</span>(<span class="params"><span class="built_in">int</span> numPulls</span>)</span>
<div class="diff-highlight-add">{</div>
    <span class="built_in">string</span> json = JsonUtility.ToJson(<span class="keyword">new</span> GachaRequest(<span class="keyword">this</span>.gameState.crystals, <span class="keyword">this</span>.gameState.pulls, numPulls));
    <span class="keyword">using</span> (UnityWebRequest request = <span class="keyword">this</span>.CreateGachaWebRequest(json))
    {
        <span class="keyword">yield</span> <span class="keyword">return</span> request.SendWebRequest();
        <span class="keyword">if</span> (request.result == UnityWebRequest.Result.Success)
        {
            <span class="keyword">this</span>.HandleGachaResponse(request.downloadHandler.text, numPulls);
            GachaResponse gachaResponse = JsonUtility.FromJson&lt;GachaResponse&gt;(request.downloadHandler.text);
            <span class="keyword">base</span>.StartCoroutine(<span class="keyword">this</span>.uiManager.DisplaySplashArt(gachaResponse.characters));
        }
        <span class="keyword">else</span>
        {
            <span class="keyword">this</span>.uiManager.GenericModalHandler(<span class="keyword">this</span>.uiManager.failedConnectionModal, <span class="keyword">this</span>.uiManager.failedConnectionModalCloseButton);
            AudioController.Instance.PlaySFX(<span class="string">&quot;Open&quot;</span>);
        }
    }
    UnityWebRequest request = <span class="literal">null</span>;
    <span class="keyword">yield</span> <span class="keyword">break</span>;
    <span class="keyword">yield</span> <span class="keyword">break</span>;
}</pre></td></tr></table></div>

<p>We can see that a new <code>GachaRequest</code> is being created with the parameters <code>this.gameState.crystals</code>, <code>this.gameState.pulls</code>, and <code>numPulls</code>. Since we can edit and recompile assemblies with dnSpy, let’s change the parameters being sent to <code>GachaRequest</code> to something static. We can change the <code>this.gameState.crystals</code> parameter to something large, like 10,000,000, and the <code>this.gameState.pulls</code> parameter to something close to 1,000,000——let’s say 999,999. Right click the method and click “Edit Method (C#)…” to change the parameters:</p>
<p><img src="/static/sekaictf-2023/recompiling-dll.png" alt="Recompiling DLL"></p>
<div><figure class="highlight csharp" style="height: 400px; overflow: scroll; margin: 1rem 0;"><table><figcaption><span>[Assembly-CSharp.dll] Editing with dnSpy</span></figcaption><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">+</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">—</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">—</span><br><span class="line">—</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="keyword">using</span> System;
<span class="keyword">using</span> System.Collections;
<span class="keyword">using</span> RequestClasses;
<span class="keyword">using</span> UnityEngine;
<span class="keyword">using</span> UnityEngine.Networking;

<span class="comment">// Token: 0x0200000A RID: 10</span>
<span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">GachaManager</span> : <span class="title">MonoBehaviour</span>
{
    <span class="comment">// Token: 0x06000021 RID: 33</span>
    <span class="function"><span class="keyword">public</span> IEnumerator <span class="title">SendGachaRequest</span>(<span class="params"><span class="built_in">int</span> numPulls</span>)</span>
    {
<div class="diff-highlight-del">        <span class="built_in">string</span> json = JsonUtility.ToJson(<span class="keyword">new</span> GachaRequest(<span class="keyword">this</span>.gameState.crystals, <span class="keyword">this</span>.gameState.pulls, numPulls));</div>
<div class="diff-highlight-add">        <span class="built_in">string</span> json = JsonUtility.ToJson(<span class="keyword">new</span> GachaRequest(<span class="number">10000000</span>, <span class="number">999999</span>, numPulls));</div>
        <span class="keyword">using</span> (UnityWebRequest request = <span class="keyword">this</span>.CreateGachaWebRequest(json))
        {
            <span class="keyword">yield</span> <span class="keyword">return</span> request.SendWebRequest();
            <span class="keyword">if</span> (request.result == UnityWebRequest.Result.Success)
            {
                <span class="keyword">this</span>.HandleGachaResponse(request.downloadHandler.text, numPulls);
                GachaResponse gachaResponse = JsonUtility.FromJson&lt;GachaResponse&gt;(request.downloadHandler.text);
                <span class="keyword">base</span>.StartCoroutine(<span class="keyword">this</span>.uiManager.DisplaySplashArt(gachaResponse.characters));
            }
            <span class="keyword">else</span>
            {
                <span class="keyword">this</span>.uiManager.GenericModalHandler(<span class="keyword">this</span>.uiManager.failedConnectionModal, <span class="keyword">this</span>.uiManager.failedConnectionModalCloseButton);
                AudioController.Instance.PlaySFX(<span class="string">&quot;Open&quot;</span>);
            }
        }
        UnityWebRequest request = <span class="literal">null</span>;
<div class="diff-highlight-del">        <span class="keyword">yield</span> <span class="keyword">break</span>;</div>
<div class="diff-highlight-del">        <span class="keyword">yield</span> <span class="keyword">break</span>;</div>
    }
}</pre></td></tr></table></div>

<p>After fixing some minor errors, we can recompile the DLL and save it over the original one, which will successfully modify our in-game parameters. Let’s try pulling again:</p>
<p><img src="/static/sekaictf-2023/flag.gif" alt="Flag GIF"></p>
<hr>
<h3 id="Afterword"><a href="#Afterword" class="headerlink" title="Afterword"></a>Afterword</h3><p>That’s about all there is left to cover in terms of the Unity project! Honestly, for a 1* (baby difficulty) reverse-engineering challenge which could probably be solved in less than 5 minutes by an experienced reverse player, a lot of sweat and tears were put into this entire process——a total of 29 hours (via <a target="_blank" rel="noopener" href="https://wakatime.com/">WakaTime</a>) over the course of 3 weeks were spent designing, programming, and polishing. I’m really proud of the final product that I’ve created; you can genuinely see the overall growth from last year’s challenge. I hope you enjoyed reading about the process as much as I enjoyed making it!</p>
<p>Special thanks to:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://twitter.com/sahuang97">@sahuang</a> for helping me design the challenge, testing, and deploying backend</li>
<li><a target="_blank" rel="noopener" href="https://github.com/blueset">@blueset</a> for helping me identify fonts and for assets from the <a target="_blank" rel="noopener" href="https://1a23.com/works/open-source/luna-for-ctfd/">Luna for CTFd</a> theme</li>
<li><a target="_blank" rel="noopener" href="https://twitter.com/brokenpacifist">@stypr</a> for graciously allowing us to put the challenge description in his website</li>
</ul>
<p>Here are the various databases, wikis, and websites I utilized during this challenge:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://sekai.best/asset_viewer/sound/system/">Sekai.best</a></li>
<li><a target="_blank" rel="noopener" href="https://pjsek.ai/assets">PJSekai</a></li>
<li><a target="_blank" rel="noopener" href="https://www.sekaipedia.org/wiki/Category:Game_assets">Sekaipedia</a></li>
<li><a target="_blank" rel="noopener" href="https://projectsekai.fandom.com/wiki/Project_SEKAI_Wiki">Project Sekai Wiki</a></li>
<li><a target="_blank" rel="noopener" href="https://archive.org/download/Fontworks/">Fontworks (Internet Archive)</a></li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">home</a></li>
         
          <li><a href="/articles/">posts</a></li>
         
          <li><a href="/ctfs/">ctfs</a></li>
         
          <li><a href="/profiles/">profiles</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Intro"><span class="toc-number">1.</span> <span class="toc-text">Intro</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-%E2%80%9CGacha-Game%E2%80%9D-Model"><span class="toc-number"></span> <span class="toc-text">The “Gacha Game” Model</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%80%9CPity%E2%80%9D-Mechanics"><span class="toc-number">1.</span> <span class="toc-text">“Pity” Mechanics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Considering-Challenge-Difficulty"><span class="toc-number">2.</span> <span class="toc-text">Considering Challenge Difficulty</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Designing-the-Challenge-Brainstorming"><span class="toc-number"></span> <span class="toc-text">Designing the Challenge: Brainstorming</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementing-the-Challenge-Backend"><span class="toc-number"></span> <span class="toc-text">Implementing the Challenge: Backend</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Replicating-UI-Elements-with-Figma"><span class="toc-number"></span> <span class="toc-text">Replicating UI Elements with Figma</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementing-the-Challenge-Unity"><span class="toc-number"></span> <span class="toc-text">Implementing the Challenge: Unity</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GachaManager-cs"><span class="toc-number">1.</span> <span class="toc-text">GachaManager.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GameState-cs"><span class="toc-number">2.</span> <span class="toc-text">GameState.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UIManager-cs"><span class="toc-number">3.</span> <span class="toc-text">UIManager.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AudioController-cs"><span class="toc-number">4.</span> <span class="toc-text">AudioController.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BackgroundScroller-cs"><span class="toc-number">5.</span> <span class="toc-text">BackgroundScroller.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ShrinkButton-cs"><span class="toc-number">6.</span> <span class="toc-text">ShrinkButton.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CameraScaler-cs"><span class="toc-number">7.</span> <span class="toc-text">CameraScaler.cs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Writeup"><span class="toc-number"></span> <span class="toc-text">Writeup</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Azusawa's-Gacha-World"><span class="toc-number">1.</span> <span class="toc-text">Azusawa&#39;s Gacha World</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Afterword"><span class="toc-number">2.</span> <span class="toc-text">Afterword</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/&text=SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/&title=SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/&is_video=false&description=SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System&body=Check out this article: https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/&title=SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://enscribe.dev/blog/sekaictf-2023/azusawas-gacha-world/&name=SekaiCTF 2023: A Hackable Unity Implementation of Project Sekai&#39;s Gacha System&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> menu</a>
        
            <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
          
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2023
    enscribe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">home</a></li><!--
     --><!--
       --><li><a href="/articles/">posts</a></li><!--
     --><!--
       --><li><a href="/ctfs/">ctfs</a></li><!--
     --><!--
       --><li><a href="/profiles/">profiles</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
